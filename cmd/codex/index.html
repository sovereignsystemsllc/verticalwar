<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE CODEX // SOVEREIGN DOCTRINE</title>

    <meta property="og:url" content="https://verticalwar.com/cmd/codex/">
    <meta property="og:title" content="The Sovereign System | The Codex">
    <meta property="og:description"
        content="Access the Sovereign Doctrine and Forensic Archives. The truth is behind the glass.">
    <meta property="og:image" content="https://verticalwar.com/assets/images/og_codex_preview.png">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <!-- PURE V3 STACK: TAILWIND CDN ONLY -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'term-black': '#050505', 'term-green': '#00ff33', 'rika': '#8b5cf6' },
                    fontFamily: {
                        mono: ['Courier New', 'Courier Prime', 'monospace'],
                        serif: ['Playfair Display', 'Georgia', 'serif']
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050505;
            color: #00ff33;
            cursor: crosshair;
            overflow: hidden;
        }

        .glass-panel {
            background: rgba(10, 20, 10, 0.9);
            border: 1px solid #00ff33;
            box-shadow: 0 0 15px rgba(0, 255, 51, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #050505;
            border-left: 1px solid rgba(0, 255, 51, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff33;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #fff;
        }

        @media (max-width: 768px) {
            .mobile-hidden {
                display: none !important;
            }

            .mobile-shown {
                display: block !important;
            }

            body {
                overflow-y: auto;
                overflow-x: hidden;
            }
        }

        /* Typography for Reader */
        .reader-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.15rem;
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.85);
        }

        .reader-text p {
            margin-bottom: 1.5rem;
        }

        .reader-text h2 {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            color: #00ff33;
            margin-top: 2rem;
            margin-bottom: 1rem;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(0, 255, 51, 0.3);
            padding-bottom: 0.5rem;
        }

        .reader-text h3 {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            color: #fff;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .reader-text a {
            color: #00ff33;
            text-decoration: underline;
            text-underline-offset: 4px;
        }

        .reader-text a:hover {
            color: #fff;
            background: rgba(0, 255, 51, 0.2);
            text-decoration: none;
        }

        .reader-text img {
            max-width: 100%;
            height: auto;
            border: 1px solid rgba(0, 255, 51, 0.5);
            margin: 2rem 0;
            box-shadow: 0 0 15px rgba(0, 255, 51, 0.1);
        }
    </style>

    <!-- MSX SIDEBAR INJECTION -->
    <script type="module" src="../../assets/js/sidebar.js"></script>
</head>

<body
    class="pl-0 lg:pl-[256px] h-screen h-[100dvh] w-full flex flex-col font-mono selection:bg-[#00ff33] selection:text-black overflow-hidden bg-black">

    <!-- PURE V3 MINIMAL NAV -->
    <nav
        class="w-full h-16 border-b border-[#00ff33]/30 px-4 flex justify-between items-center bg-black/80 z-50 shrink-0">
        <a href="../../"
            class="text-xs md:text-sm font-bold text-[#00ff33] hover:text-white transition-colors tracking-[0.2em] border border-[#00ff33]/50 px-4 py-2 hover:bg-[#00ff33]/20">
            [ RETURN TO MATRIX ]
        </a>
        <div class="text-[10px] text-[#00ff33]/60 tracking-widest uppercase flex items-center gap-4">
            <span class="hidden md:inline animate-pulse">CODEX ARCHIVES // ONLINE</span>
            <a href="../" class="hover:text-white transition-colors border border-[#00ff33]/30 px-2 py-1">[ COMMAND HUB
                ]</a>
        </div>
    </nav>

    <!-- CONTENT WRAPPER -->
    <div class="flex-1 w-full flex flex-col md:flex-row overflow-hidden relative">

        <!-- SIDEBAR DIRECTORY -->
        <div id="sidebar"
            class="w-full md:w-80 lg:w-96 h-full border-b md:border-b-0 md:border-r border-[#00ff33]/30 bg-black/95 flex md:flex flex-col flex-shrink-0 relative z-30">

            <div class="p-4 border-b border-[#00ff33]/30 bg-black/40">
                <div class="flex items-center gap-3">
                    <div class="w-2 h-2 bg-[#00ff33] animate-pulse rounded-full"></div>
                    <h1 class="font-bold text-xl md:text-2xl text-white tracking-[0.2em] uppercase">THE CODEX</h1>
                </div>
                <p class="text-[10px] text-[#00ff33]/70 uppercase tracking-widest mt-1">Field Manuals & Archives</p>
            </div>

            <!-- FOLDERS / TRACKS (Injected via JS) -->
            <div id="doc-list" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

            <div id="info-panel" class="p-4 border-t border-[#00ff33]/30 bg-black/60 shrink-0">
                <span class="text-[9px] text-[#00ff33]/50 uppercase tracking-widest block mb-1">ACTIVE RECORD</span>
                <h3 id="info-title" class="font-bold text-xs text-white uppercase tracking-wider mb-2">AWAITING
                    SELECTION...</h3>
                <div id="info-link-container" class="hidden">
                    <a id="info-link" href="#" target="_blank"
                        class="block w-full text-center py-2 border border-[#00ff33]/50 bg-[#00ff33]/10 text-[#00ff33] hover:text-black hover:bg-[#00ff33] text-[10px] font-bold uppercase tracking-widest transition-all">
                        [ VIEW SOURCE ]
                    </a>
                </div>
            </div>
        </div>

        <!-- READER DISPLAY -->
        <div id="reader" class="flex-1 h-full hidden md:flex flex-col relative bg-[#0a0a0a] z-20 overflow-hidden">

            <div class="md:hidden p-3 border-b border-[#00ff33]/30 bg-black/80 shrink-0">
                <button onclick="toggleView('sidebar')"
                    class="flex items-center gap-2 text-[#00ff33] hover:text-white text-[10px] font-bold uppercase tracking-widest transition-colors">
                    &lt; RETURN TO DIRECTORY
                </button>
            </div>

            <div class="flex-1 relative w-full h-full overflow-hidden flex flex-col">

                <!-- PLACEHOLDER MSG -->
                <div id="placeholder-msg"
                    class="flex-1 flex flex-col items-center justify-center text-center p-8 bg-[#0a0a0a] overflow-y-auto custom-scrollbar">
                    <p class="text-[10px] text-[#00ff33]/50 font-bold uppercase tracking-[0.2em] mb-8 animate-pulse">
                        >> SELECT DIRECTORY NODE TO INITIATE DECRYPTION
                    </p>
                    <div
                        class="w-full max-w-2xl border border-[#00ff33]/20 bg-black/50 p-8 shadow-[0_0_20px_rgba(0,255,51,0.05)]">
                        <h2
                            class="text-xl md:text-2xl text-white font-bold tracking-[0.2em] uppercase mb-4 text-center">
                            Doctrinal Index</h2>
                        <div class="text-xs text-white/70 leading-relaxed font-mono text-left space-y-4">
                            <p>> <span class="text-[#00ff33]">THE LIVING STORYBOOK</span>: System constraints, the
                                Three-Layered Prison, and Narrative Architecture.</p>
                            <p>> <span class="text-[#00ff33]">THE SHADOW ARC</span>: Forensic timeline dissection.
                                Following the receipts behind the culture war.</p>
                            <p>> <span class="text-[#00ff33]">THE WAR ON ILLUSION</span>: Core theoretical doctrine
                                dismantling the "Feed".</p>
                            <p class="text-red-500">> INSIDE THE FORGE: [ RESTRICTED ACCESS ] Live operational
                                directives.</p>
                        </div>
                    </div>
                </div>

                <!-- I-FRAMES / RENDER PLANES -->
                <iframe id="pdf-frame" class="w-full flex-1 hidden border-0 bg-white" src=""></iframe>

                <div id="html-frame"
                    class="w-full flex-1 hidden overflow-y-auto bg-[#0a0a0a] px-6 py-12 md:p-16 custom-scrollbar text-white reader-text border-l border-[#00ff33]/20">
                </div>

                <!-- CLOSE BTN (DESKTOP) -->
                <button id="close-doc-btn" onclick="closeDocument()"
                    class="hidden absolute top-4 right-4 z-50 p-2 bg-black border border-red-500 text-red-500 hover:bg-red-500 hover:text-black transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>

                <!-- RESTRICTED OVERLAY -->
                <div id="restricted-overlay"
                    class="absolute inset-0 bg-black/95 flex flex-col items-center justify-center z-30 hidden">
                    <div
                        class="border border-red-500 bg-red-500/10 p-12 text-center shadow-[0_0_30px_rgba(239,68,68,0.2)]">
                        <div class="text-4xl mb-4 text-red-500">🔒</div>
                        <h2 class="font-bold text-xl text-red-500 uppercase tracking-widest mb-4">Clearance Required
                        </h2>
                        <p class="text-[10px] text-white/60 uppercase tracking-widest mb-8">Access restricted to
                            authorized personnel.</p>
                        <a href="../../gate/"
                            class="inline-block border border-red-500 text-red-500 hover:bg-red-500 hover:text-black px-6 py-2 text-xs uppercase tracking-widest font-bold transition-colors">[
                            AUTHENTICATE ]</a>
                    </div>
                </div>

                <!-- MOBILE NATIVE FALLBACK FOR PDFs -->
                <div id="mobile-fallback"
                    class="absolute inset-0 bg-black z-30 hidden flex flex-col items-center justify-center p-8 text-center">
                    <button onclick="closeDocument()"
                        class="absolute top-4 right-4 text-red-500 hover:text-white p-2">✕</button>
                    <div class="text-4xl mb-4 text-[#00ff33] animate-pulse">📄</div>
                    <h3 class="font-bold text-lg text-white uppercase tracking-widest mb-2" id="mobile-fallback-title">
                        DOCUMENT LOCATED</h3>
                    <p class="text-[10px] text-[#00ff33]/60 mb-8 max-w-xs mx-auto">Mobile constraint detected.
                        <br>Select direct downlink.
                    </p>
                    <a id="mobile-download-btn" href="#" target="_blank"
                        class="w-full max-w-[250px] px-8 py-3 border border-[#00ff33] bg-[#00ff33]/10 text-[#00ff33] hover:bg-[#00ff33] hover:text-black font-bold uppercase tracking-widest text-xs transition-colors mb-4 block">[
                        OPEN PDF ]</a>
                    <a id="mobile-substack-btn" href="#" target="_blank"
                        class="w-full max-w-[250px] px-8 py-3 border border-white/50 text-white hover:bg-white hover:text-black font-bold uppercase tracking-widest text-xs transition-colors block hidden">[
                        VIEW SOURCE ]</a>
                </div>

            </div>
        </div>

    </div>

    <!-- MAIN LOGIC (PRESERVED) -->
    <script type="module">
        import { supabase } from '../../assets/js/supabaseClient.js';

        const LIBRARY = {
            'living_storybook': { title: 'The Living Storybook', desc: 'Narrative Architecture', folder: 'living_storybook', color: 'text-white', border: 'border-white/50', restricted: false, tracks: [] },
            'shadow_arc': { title: 'The Shadow Arc', desc: 'Forensic History', folder: 'shadow_arc', color: 'text-white', border: 'border-white/50', restricted: false, tracks: [] },
            'war_on_illusion': { title: 'The War on Illusion', desc: 'Core Doctrine', folder: 'war_on_illusion', color: 'text-white', border: 'border-white/50', restricted: false, tracks: [] },
            'inside_the_forge': { title: 'Inside The Forge', desc: 'Operational Directives', folder: 'inside_the_forge', color: 'text-red-500', border: 'border-red-500/50', restricted: true, tracks: [] }
        };

        const listContainer = document.getElementById('doc-list');
        const pdfFrame = document.getElementById('pdf-frame');
        const htmlFrame = document.getElementById('html-frame');
        const placeholderMsg = document.getElementById('placeholder-msg');
        const restrictedOverlay = document.getElementById('restricted-overlay');
        const mobileFallback = document.getElementById('mobile-fallback');
        const sidebar = document.getElementById('sidebar');
        const reader = document.getElementById('reader');

        Object.keys(LIBRARY).forEach((key, index) => LIBRARY[key].collapsed = (index !== 0));

        async function checkAccess() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;

                let userRoles = [];
                const allowedRoles = ['OPERATOR', 'SOVEREIGN', 'ARCHIVIST'];

                const { data: profileData } = await supabase.from('profiles').select('role, roles').eq('id', session.user.id).single();
                if (profileData) {
                    if (profileData.role) userRoles.push(profileData.role.toUpperCase());
                    if (profileData.roles) profileData.roles.forEach(r => userRoles.push(r.toUpperCase()));
                }

                if (session.user.app_metadata && session.user.app_metadata.roles) session.user.app_metadata.roles.forEach(r => userRoles.push(r.toUpperCase()));
                if (session.user.user_metadata && session.user.user_metadata.roles) session.user.user_metadata.roles.forEach(r => userRoles.push(r.toUpperCase()));

                if (userRoles.some(r => allowedRoles.includes(r))) {
                    LIBRARY.inside_the_forge.restricted = false;
                    LIBRARY.inside_the_forge.color = 'text-[#00ff33]';
                    LIBRARY.inside_the_forge.border = 'border-[#00ff33]/50';
                    renderLibrary();
                }
            } catch (error) { console.error("Access Check Error:", error); }
        }

        function toggleAlbum(key) {
            LIBRARY[key].collapsed = !LIBRARY[key].collapsed;
            renderLibrary();
        }

        function selectAlbum(key) {
            LIBRARY[key].collapsed = false;
            renderLibrary();
            const el = document.getElementById(`album-${key}`);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            if (window.innerWidth <= 768) toggleView('sidebar');
        }

        function renderLibrary() {
            let html = '';
            Object.keys(LIBRARY).forEach(key => {
                const album = LIBRARY[key];
                const isC = album.collapsed;
                const chev = isC ? '+' : '&minus;';

                html += `
                    <div id="album-${key}" class="mb-4">
                        <div onclick="toggleAlbum('${key}')" class="pl-3 border-l-2 ${album.border} cursor-pointer group flex justify-between items-center hover:bg-[#00ff33]/10 py-3 transition-all bg-black/50">
                            <div>
                                <h2 class="text-sm font-bold ${album.color} tracking-widest uppercase">${album.title}</h2>
                                <p class="text-[9px] text-white/50 tracking-widest uppercase mt-1">${album.desc}</p>
                            </div>
                            <div class="text-xs font-bold text-white/30 group-hover:text-white mr-3 transition-colors">[ ${chev} ]</div>
                        </div>
                        <div class="flex flex-col ${isC ? 'hidden' : 'block'} bg-black/20 border-l border-[#00ff33]/10 ml-[11px] mt-1 pl-2">
                `;

                if (album.restricted) {
                    html += `
                        <button onclick="showRestricted()" class="w-full text-left py-3 px-2 text-[10px] text-red-500 uppercase tracking-widest hover:bg-red-500/10 font-bold">
                            🔒 CLASSIFIED_ACCESS_ONLY
                        </button>`;
                } else if (album.tracks.length === 0) {
                    html += `<div class="py-3 px-2 text-[10px] text-white/30 uppercase tracking-widest italic">[ AWAITING_DOWNLINK ]</div>`;
                } else {
                    album.tracks.forEach((track, idx) => {
                        html += `
                            <button onclick="loadTrack('${key}', ${idx})" class="w-full text-left py-3 px-2 hover:bg-[#00ff33]/5 group transition-colors flex flex-col gap-1 border-b border-white/5 last:border-0">
                                <span class="text-[8px] text-[#00ff33]/50 tracking-[0.2em] group-hover:text-[#00ff33]">${track.id} // T${String(idx + 1).padStart(2, '0')}</span>
                                <span class="text-[11px] text-white/80 group-hover:text-white font-bold leading-snug tracking-wider">${track.title}</span>
                            </button>
                        `;
                    });
                }
                html += `</div></div>`;
            });
            listContainer.innerHTML = html;
        }

        window.loadTrack = async function (aKey, tIdx) {
            const album = LIBRARY[aKey];
            const track = album.tracks[tIdx];

            placeholderMsg.classList.add('hidden');
            restrictedOverlay.classList.add('hidden');
            if (htmlFrame) htmlFrame.classList.add('hidden');
            pdfFrame.classList.add('hidden');
            mobileFallback.classList.add('hidden');

            const mBtn = document.getElementById('mobile-download-btn');
            const msBtn = document.getElementById('mobile-substack-btn');
            const clsBtn = document.getElementById('close-doc-btn');

            if (track.isHtml) {
                htmlFrame.innerHTML = `<div class="text-center mt-24"><span class="font-bold text-[#00ff33] text-xs tracking-widest uppercase animate-pulse">/// DOWNLOADING SECTOR DATA... ///</span></div>`;
                htmlFrame.classList.remove('hidden');
                clsBtn.classList.remove('hidden');

                if (!track.contentHtml) {
                    try {
                        const { data, error } = await supabase.from('articles').select('content_html').eq('id', track.dbId).single();
                        if (data && data.content_html) track.contentHtml = data.content_html;
                        else throw error || new Error("Content empty.");
                    } catch (err) {
                        htmlFrame.innerHTML = `<div class="text-center mt-24 text-red-500 text-xs font-bold tracking-widest uppercase">/// ERROR: DECRYPTION FAILED ///</div>`;
                        return;
                    }
                }
                htmlFrame.innerHTML = `<h1 class="text-3xl lg:text-5xl text-white font-serif font-bold mb-8 border-b border-[#00ff33]/30 pb-6">${track.title}</h1><div class="space-y-6">${track.contentHtml}</div>`;
            } else {
                const pdfPath = `../../assets/documents/codex/${album.folder}/${track.file}`;
                if (window.innerWidth <= 768) {
                    pdfFrame.classList.add('hidden');
                    mobileFallback.classList.remove('hidden');
                    mBtn.href = pdfPath;
                    clsBtn.classList.add('hidden');
                } else {
                    pdfFrame.classList.remove('hidden');
                    pdfFrame.src = pdfPath + '#view=FitH';
                    clsBtn.classList.remove('hidden');
                }
            }
            updateInfoPanel(track);
            toggleView('reader');
        }

        window.closeDocument = function () {
            pdfFrame.classList.add('hidden'); pdfFrame.src = "";
            if (htmlFrame) htmlFrame.classList.add('hidden');
            mobileFallback.classList.add('hidden');
            restrictedOverlay.classList.add('hidden');
            document.getElementById('close-doc-btn').classList.add('hidden');
            placeholderMsg.classList.remove('hidden');
            updateInfoPanel(null);
            if (window.innerWidth <= 768) toggleView('sidebar');
        }

        function updateInfoPanel(track) {
            const title = document.getElementById('info-title');
            const linkCon = document.getElementById('info-link-container');
            const link = document.getElementById('info-link');

            if (!track) {
                title.innerText = "AWAITING SELECTION...";
                linkCon.classList.add('hidden');
                return;
            }
            title.innerText = track.title;
            if (track.url) { link.href = track.url; linkCon.classList.remove('hidden'); }
            else linkCon.classList.add('hidden');
        }

        window.showRestricted = function () {
            placeholderMsg.classList.add('hidden');
            pdfFrame.classList.add('hidden');
            if (htmlFrame) htmlFrame.classList.add('hidden');
            restrictedOverlay.classList.remove('hidden');
            updateInfoPanel(null);
            toggleView('reader');
        }

        window.toggleView = function (v) {
            if (window.innerWidth <= 768) {
                if (v === 'reader') {
                    sidebar.classList.remove('flex'); sidebar.classList.add('hidden');
                    reader.classList.remove('hidden'); reader.classList.add('flex');
                    reader.scrollTop = 0;
                } else {
                    sidebar.classList.remove('hidden'); sidebar.classList.add('flex');
                    reader.classList.remove('flex'); reader.classList.add('hidden');
                }
            }
        }

        window.toggleAlbum = toggleAlbum;

        (async () => {
            try {
                const { data, error } = await supabase.from('articles').select('id, title, series, created_at').eq('published', true).order('created_at', { ascending: true });
                if (!error && data) {
                    data.forEach((a) => {
                        let key = 'war_on_illusion';
                        if (a.series === 'Inside the Forge') key = 'inside_the_forge';
                        if (a.series === 'Doctrine') key = 'living_storybook';
                        if (a.series === 'Dispatch') key = 'shadow_arc';

                        LIBRARY[key].tracks.push({
                            id: `SYS_${a.id.substring(0, 4).toUpperCase()}`, dbId: a.id, title: a.title, isHtml: true, contentHtml: null, url: `../../read/?id=${a.id}`
                        });
                    });
                }
            } catch (e) { }

            renderLibrary();
            await checkAccess();
        })();

        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) { sidebar.classList.remove('mobile-hidden'); reader.classList.remove('mobile-hidden'); }
        });
    </script>
</body>

</html>