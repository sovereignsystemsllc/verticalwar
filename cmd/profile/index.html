<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOVEREIGN DOSSIER // PHALANX</title>
    
    <!-- PURE V3 STACK: TAILWIND CDN ONLY. NO EXTERNAL OR LEGACY SCRIPTS. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'term-black': '#050505', 'term-green': '#22c55e' },
                    fontFamily: { mono: ['Courier New', 'monospace'] }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050505;
            color: #22c55e;
            cursor: crosshair;
            display: none; /* Anti-flicker */
        }
        
        .glass-panel {
            background: rgba(10, 20, 10, 0.9);
            border: 1px solid #22c55e;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.1);
        }

        .input-heavy {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(34, 197, 94, 0.5);
            color: white;
            padding: 1rem;
            width: 100%;
            font-size: 1.25rem;
            text-transform: uppercase;
            outline: none;
            transition: all 0.2s ease;
        }

        .input-heavy:focus {
            border-color: #22c55e;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
        }

        /* Dossier Read-Only Mode */
        body.mode-read-only .glass-panel {
            border-color: #444;
            box-shadow: none;
        }
        body.mode-read-only .text-term-green { color: #888; text-shadow: none; }
    </style>
</head>

<body class="min-h-screen w-full font-mono pb-24 selection:bg-[#22c55e] selection:text-black">

    <!-- PURE V3 MINIMAL NAV -->
    <nav class="w-full border-b border-[#22c55e]/30 p-4 mb-8 flex justify-between items-center bg-[#05010a]/80">
        <a href="../../" class="text-sm font-bold text-[#22c55e] hover:text-white transition-colors tracking-[0.2em] border border-[#22c55e]/50 px-4 py-2 hover:bg-[#22c55e]/20">
            [ RETURN TO MATRIX ]
        </a>
        <div class="text-[10px] text-[#22c55e]/60 tracking-widest uppercase flex items-center gap-4">
            <span id="nav-status-indicator" class="animate-pulse">LOCAL SYNC ACTIVE</span>
            <button id="nav-logout-btn" class="hidden hover:text-red-500 transition-colors">[ DE-LINK ]</button>
        </div>
    </nav>

    <div id="main-container" class="max-w-4xl mx-auto px-4 flex flex-col gap-8 opacity-0 transition-opacity duration-500">
        
        <!-- HEADER -->
        <div class="border-b border-[#22c55e]/40 pb-4">
            <h1 class="text-3xl md:text-5xl font-bold tracking-[0.1em] text-[#22c55e] uppercase ">SOVEREIGN DOSSIER</h1>
            <div class="text-xs text-[#22c55e]/60 tracking-widest mt-3 uppercase font-bold" id="mode-indicator">
                >> OPERATOR UPLINK ESTABLISHED. EDIT MODE ACTIVE.
            </div>
        </div>

        <!-- DOSSIER CARD -->
        <div class="glass-panel p-6 md:p-10 flex flex-col md:flex-row gap-10 relative">
            
            <!-- AVATAR UPLOAD -->
            <div class="flex flex-col items-center gap-4 shrink-0">
                <div id="avatar-container" class="w-48 h-48 border border-[#22c55e]/50 bg-[#05010a] relative group cursor-pointer hover:border-[#22c55e] transition-all overflow-hidden rounded-sm ">
                    <img id="avatar-img" src="" alt="Avatar" class="w-full h-full object-cover p-2 opacity-80 group-hover:opacity-100 transition-opacity">
                    <div id="upload-overlay" class="absolute inset-0 bg-[#05010a]/90 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-xs font-bold tracking-widest text-[#22c55e] border border-[#22c55e] px-3 py-1">[ UPLOAD BIO-SCAN ]</span>
                    </div>
                    <input type="file" id="avatar-upload" class="hidden" accept="image/*">
                </div>
                <div class="text-[10px] font-bold text-[#22c55e]/70 tracking-widest text-center uppercase" id="join-date">> CHRONOLOGY: UNKNOWN</div>
            </div>

            <!-- CORE DATA -->
            <div class="flex-1 flex flex-col gap-8 w-full">
                
                <div class="space-y-3">
                    <label class="text-xs font-bold text-[#22c55e] tracking-[0.2em] uppercase block">I. CALLSIGN (IDENTITY)</label>
                    <input type="text" id="username-input" class="input-heavy font-bold" placeholder="ENTER CALLSIGN...">
                </div>

                <div class="space-y-3">
                    <label class="text-xs font-bold text-[#22c55e] tracking-[0.2em] uppercase block">II. CLEARANCE LEVEL</label>
                    <div id="rank-display" class="w-full bg-[#22c55e]/10 border border-[#22c55e]/30 p-4 text-[#22c55e] text-lg font-bold tracking-widest cursor-not-allowed">
                        AWAITING SYNC...
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="text-xs font-bold text-[#22c55e] tracking-[0.2em] uppercase block">III. HARDWARE (SKILL / TRADE)</label>
                    <input type="text" id="hardware-input" class="input-heavy placeholder-[#22c55e]/30" placeholder="E.G. WELDER, FARMER, EMT...">
                    <div class="text-[10px] text-[#22c55e]/60 tracking-widest mt-2 uppercase">Physical real-world utility required for Syndicate deployment.</div>
                </div>

                <!-- SAVE / TX -->
                <div class="pt-6 border-t border-[#22c55e]/20 flex justify-end" id="action-bar">
                    <button id="save-btn" class="bg-[#22c55e]/20 border border-[#22c55e] text-[#22c55e] hover:bg-[#22c55e] hover:text-black font-bold px-10 py-4 transition-all tracking-[0.2em] flex items-center gap-3 w-full sm:w-auto justify-center text-sm">
                        [ COMMIT TO LEDGER ]
                    </button>
                </div>

            </div>
        </div>

        <!-- PUBLIC READ-ONLY WARNING -->
        <div id="public-warning" class="hidden text-center text-[10px] text-zinc-500 font-bold tracking-[0.2em] mt-8 border border-zinc-800 p-4 bg-[#05010a]/80">
            THIS DOSSIER IS CLASSIFIED. YOU ARE VIEWING CACHED PUBLIC METADATA.
        </div>

    </div>

    <!-- PURE SUPABASE UPLINK -->
    <script type="module">
        import { supabase } from '../../assets/js/supabaseClient.js';

        const UI = {
            body: document.body,
            container: document.getElementById('main-container'),
            modeIndicator: document.getElementById('mode-indicator'),
            avatarImg: document.getElementById('avatar-img'),
            avatarContainer: document.getElementById('avatar-container'),
            avatarUpload: document.getElementById('avatar-upload'),
            usernameInput: document.getElementById('username-input'),
            rankDisplay: document.getElementById('rank-display'),
            hardwareInput: document.getElementById('hardware-input'),
            saveBtn: document.getElementById('save-btn'),
            joinDate: document.getElementById('join-date'),
            actionBar: document.getElementById('action-bar'),
            publicWarning: document.getElementById('public-warning'),
            logoutBtn: document.getElementById('nav-logout-btn')
        };

        let Session = { user: null, mode: 'private', targetId: null, settings: {} };

        // 1. INIT - ZERO PLUGINS
        async function bootstrap() {
            try {
                const params = new URLSearchParams(window.location.search);
                const queryUser = params.get('user');

                if (queryUser) {
                    Session.mode = 'public';
                    await loadPublicDossier(queryUser);
                } else {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) return window.location.href = '/gate/';
                    Session.user = session.user;
                    Session.targetId = session.user.id;
                    
                    UI.logoutBtn.classList.remove('hidden');
                    UI.logoutBtn.onclick = async () => {
                        await supabase.auth.signOut();
                        window.location.href = '/gate/';
                    };

                    await loadPrivateDossier();
                }
            } catch (err) {
                console.error("FATAL BIND ERROR:", err);
                alert("UPLINK FAILED.");
            }
        }

        // 2. FETCH DATA DIRECT FROM SOURCE
        async function loadPrivateDossier() {
            const { data, error } = await supabase
                .from('profiles')
                .select('username, role, avatar_url, settings, created_at')
                .eq('id', Session.targetId)
                .single();

            if (error) return console.error(error);
            render(data);
            bindEvents();
            showInterface();
        }

        async function loadPublicDossier(username) {
            UI.body.classList.add('mode-read-only');
            UI.modeIndicator.innerText = `>> DOSSIER QUERY: ${username.toUpperCase()}`;
            
            const { data, error } = await supabase
                .from('profiles')
                .select('username, role, avatar_url, settings, created_at')
                .eq('username', username)
                .single();

            if (error || !data) {
                UI.container.innerHTML = `<div class="text-center text-red-500 font-bold text-2xl mt-40 tracking-[0.2em] border border-red-500 p-8 bg-[#05010a]/90">>> 404: TARGET NOT FOUND <<</div>`;
                return showInterface();
            }

            render(data, true);
            showInterface();
            
            // UI Locks
            UI.usernameInput.disabled = true;
            UI.hardwareInput.disabled = true;
            UI.avatarContainer.classList.remove('cursor-pointer', 'hover:border-[#22c55e]');
            document.getElementById('upload-overlay').remove();
            UI.actionBar.style.display = 'none';
            UI.publicWarning.classList.remove('hidden');
        }

        // 3. PURE RENDER
        function render(data, isPublic = false) {
            UI.usernameInput.value = data.username || '';
            UI.rankDisplay.innerText = `[ ${data.role ? data.role.toUpperCase() : 'OPERATIVE'} ]`;
            
            // Hardware Extractor
            Session.settings = data.settings || {};
            UI.hardwareInput.value = Session.settings.hardware_skill || '';

            // Pure Avatar Logic
            let avSrc = data.avatar_url;
            if (avSrc && !avSrc.startsWith('http')) {
                const { data: pUrl } = supabase.storage.from('avatars').getPublicUrl(avSrc);
                avSrc = pUrl.publicUrl;
            }
            if (!avSrc) avSrc = `https://api.dicebear.com/9.x/shapes/svg?seed=${data.username || 'anon'}&backgroundColor=000000&shape1Color=00ff33`;
            UI.avatarImg.src = avSrc;

            if (data.created_at) {
                const d = new Date(data.created_at);
                UI.joinDate.innerText = `> CHRONOLOGY: ${d.toLocaleDateString()}`;
            }

            if(data.role === 'Operator') {
                UI.rankDisplay.classList.replace('text-[#22c55e]', 'text-yellow-400');
                UI.rankDisplay.classList.replace('bg-[#22c55e]/10', 'bg-yellow-400/10');
            }
        }

        function showInterface() {
            UI.body.style.display = 'block';
            setTimeout(() => UI.container.classList.remove('opacity-0'), 50);
        }

        // 4. BINDINGS
        function bindEvents() {
            UI.avatarContainer.onclick = () => UI.avatarUpload.click();
            UI.avatarUpload.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('user_id', Session.targetId);

                UI.saveBtn.innerText = "[ UPLOADING BIO-SCAN... ]";
                try {
                    const res = await fetch('../../api/upload_avatar.php', { method: 'POST', body: formData });
                    const resData = await res.json();
                    if(resData.success) {
                        const { data } = supabase.storage.from('avatars').getPublicUrl(resData.path);
                        UI.avatarImg.src = data.publicUrl;
                    }
                } catch(err) { console.error("Upload failed", err); }
                UI.saveBtn.innerHTML = "[ COMMIT TO LEDGER ]";
            };

            UI.saveBtn.onclick = async () => {
                const newUsername = UI.usernameInput.value.trim();
                Session.settings.hardware_skill = UI.hardwareInput.value.trim();

                const originalHTML = UI.saveBtn.innerHTML;
                UI.saveBtn.innerText = "[ COMMITTING... ]";

                const { error } = await supabase
                    .from('profiles')
                    .update({ username: newUsername, settings: Session.settings })
                    .eq('id', Session.targetId);

                if (error) {
                    alert("ERROR SAVING DOSSIER.");
                } else {
                    UI.saveBtn.innerText = "[ DATABANK SYNCED ]";
                    UI.saveBtn.classList.replace('border-[#22c55e]', 'border-white');
                    UI.saveBtn.classList.replace('text-[#22c55e]', 'text-white');
                }
                
                setTimeout(() => {
                    UI.saveBtn.innerHTML = originalHTML;
                    UI.saveBtn.classList.replace('border-white', 'border-[#22c55e]');
                    UI.saveBtn.classList.replace('text-white', 'text-[#22c55e]');
                }, 2000);
            };
        }

        bootstrap();
    </script>
</body>
</html>