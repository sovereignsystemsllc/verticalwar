<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOVEREIGN // PROGRESS LEADERBOARD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'void': '#000000',
                        'term-color': '#10b981', /* Green theme for Observer/Leaderboard */
                        'term-red': '#ef4444',
                        'term-gold': '#f59e0b'
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>

    <!-- AUTH GUARD (SYNCHRONOUS SPEED LOCK) -->
    <script>
            (function () {
                const STORAGE_KEY = 'sb-zazzwdaexhkeusfjdphv-auth-token';
                const session = localStorage.getItem(STORAGE_KEY);
                if (!session) {
                    window.location.replace('../../../gate/?mode=login');
                }
            })();
    </script>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
        }

        .glitch-text {
            text-shadow: 2px 0 red, -2px 0 blue;
            animation: glitch 2s infinite;
        }

        @keyframes glitch {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.9;
                text-shadow: 2px 0 red, -2px 0 blue;
            }

            100% {
                opacity: 1;
            }
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #111;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>

    <!-- React Content -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- UI Scripts -->
    <script type="module" src="../../../assets/js/nav_bar.js?v=23"></script>

    <!-- OPEN GRAPH INJECTION -->
    <meta property="og:url" content="https://verticalwar.com/cmd/override/progress/">
    <meta property="og:image" content="https://verticalwar.com/assets/images/og_terminal_preview.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://verticalwar.com/assets/images/og_terminal_preview.png">
</head>

<body class="flex items-center justify-center min-h-screen p-4">

    <div id="root" class="max-w-6xl w-full"></div>

    <script type="module">
        import { supabase } from '../../../assets/js/supabaseClient.js';
        import { CURRICULUM } from '../../../assets/js/progressManager.js';
        window.supabase = supabase; // Provide globally for React
        window.SOVEREIGN_CURRICULUM = CURRICULUM;
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const ProgressDashboard = () => {
            const [users, setUsers] = useState([]);
            const [curriculum, setCurriculum] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [authorized, setAuthorized] = useState(false);
            const [expandedUserId, setExpandedUserId] = useState(null);

            useEffect(() => {
                checkAuthAndLoad();
            }, []);

            const checkAuthAndLoad = async () => {
                try {
                    const { data: { session } } = await window.supabase.auth.getSession();
                    if (!session) {
                        window.location.href = '/gate/';
                        return;
                    }

                    // Check Role
                    const { data: myProfile, error: profileErr } = await window.supabase
                        .from('profiles')
                        .select('role')
                        .eq('id', session.user.id)
                        .single();

                    if (profileErr || !myProfile || myProfile.role !== 'Sovereign') {
                        setError("ACCESS DENIED: SOVEREIGN CLEARANCE REQUIRED.");
                        setLoading(false);
                        return;
                    }

                    setAuthorized(true);

                    // Load Curriculum data dynamically
                    setCurriculum(window.SOVEREIGN_CURRICULUM || []);

                    loadLeaderboard();

                } catch (err) {
                    console.error("Auth check failed:", err);
                    setError("SYSTEM ERROR.");
                    setLoading(false);
                }
            };

            const loadLeaderboard = async () => {
                try {
                    setLoading(true);
                    const { data: profiles, error: dbErr } = await window.supabase
                        .from('profiles')
                        .select('id, username, role, created_at, sovereign_progress');

                    if (dbErr) throw dbErr;

                    // Calculate Scores
                    const scoredUsers = profiles.map(p => {
                        let score = 0;
                        let lastActive = 0;
                        if (p.sovereign_progress) {
                            // Count completed modules
                            score = Object.keys(p.sovereign_progress).filter(k => p.sovereign_progress[k].done).length;
                            // Find latest timestamp in progress if available
                            const timestamps = Object.values(p.sovereign_progress)
                                .map(v => v.timestamp)
                                .filter(t => t);
                            if (timestamps.length > 0) {
                                lastActive = Math.max(...timestamps);
                            }
                        }

                        // Fallback to created_at if no progress timestamps
                        if (lastActive === 0 && p.created_at) {
                            lastActive = new Date(p.created_at).getTime();
                        }

                        return {
                            ...p,
                            score,
                            lastActive
                        };
                    });

                    // Sort by Score (Descending), then Last Active (Descending)
                    scoredUsers.sort((a, b) => {
                        if (b.score !== a.score) return b.score - a.score;
                        return b.lastActive - a.lastActive;
                    });

                    setUsers(scoredUsers);
                    setLoading(false);

                } catch (err) {
                    console.error("Leaderboard error:", err);
                    setError("FAILED TO RETRIEVE PROGRESS DATA.");
                    setLoading(false);
                }
            };

            const formatDate = (timestamp) => {
                if (!timestamp) return 'UNKNOWN';
                const d = new Date(timestamp);
                return d.toISOString().split('T')[0] + ' ' + d.toTimeString().split(' ')[0];
            };

            const toggleExpand = (id) => {
                if (expandedUserId === id) {
                    setExpandedUserId(null);
                } else {
                    setExpandedUserId(id);
                }
            };

            const renderUserProgress = (user) => {
                if (!curriculum.length) return <div className="text-zinc-500 text-xs">Loading curriculum...</div>;

                const tracks = {};
                curriculum.forEach(item => {
                    const tName = item.track || 'MISC';
                    if (!tracks[tName]) tracks[tName] = [];
                    tracks[tName].push(item);
                });

                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-xs p-4 bg-black/40 border border-zinc-800">
                        {Object.keys(tracks).sort().map(trackName => (
                            <div key={trackName} className="border border-zinc-900 bg-zinc-900/40 p-3 rounded">
                                <h4 className="text-[10px] text-term-green/50 uppercase tracking-widest mb-2 border-b border-zinc-800 pb-1">{trackName}</h4>
                                <div className="flex flex-col gap-1">
                                    {tracks[trackName].map(step => {
                                        const isDone = user.sovereign_progress && user.sovereign_progress[step.achievement]?.done;
                                        return (
                                            <div key={step.id} className="flex justify-between items-center py-1">
                                                <span className={isDone ? 'text-zinc-500 line-through' : 'text-zinc-300 font-bold'}>{step.title}</span>
                                                <span className={isDone ? 'text-term-gold text-[10px]' : 'text-zinc-600 text-[10px]'}>
                                                    {isDone ? '[ COMPLETE ]' : '[ PENDING ]'}
                                                </span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ))}
                    </div>
                );
            };

            if (error) {
                return (
                    <div class="border border-term-red bg-zinc-900/50 p-8 text-center max-w-md mx-auto">
                        <div class="text-4xl mb-4">ðŸ”’</div>
                        <h2 class="text-xl font-bold text-term-red mb-2">{error}</h2>
                        <a href="/" class="text-xs text-zinc-500 hover:text-white underline">[ RETURN TO BASE ]</a>
                    </div>
                );
            }

            if (loading) {
                return <div className="text-center text-term-green animate-pulse text-xs tracking-widest mt-24">SCANNING NETWORK PROGRESS...</div>;
            }

            return (
                <div className="border border-zinc-800 p-4 md:p-8 bg-black/80 backdrop-blur">
                    {/* HEADER */}
                    <div className="flex justify-between items-end mb-8 border-b border-zinc-800 pb-4">
                        <div>
                            <h1 className="text-xl md:text-2xl font-bold text-term-green uppercase tracking-widest">
                                // GLOBAL PROGRESS LEADERBOARD
                            </h1>
                            <p className="text-[10px] md:text-xs text-zinc-500 mt-1">SOVEREIGN OVERSIGHT OVER MULTIPLE OPERATIVES</p>
                        </div>
                        <a href="/cmd/override/" className="text-xs text-zinc-600 hover:text-white underline">
                            [ RETURN TO OVERRIDE ]
                        </a>
                    </div>

                    {/* STATS OVERVIEW */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div className="border border-zinc-800 bg-zinc-900/30 p-4 rounded text-center">
                            <div className="text-[10px] text-zinc-500 uppercase tracking-widest">Total Operatives</div>
                            <div className="text-xl font-bold text-white">{users.length}</div>
                        </div>
                        <div className="border border-zinc-800 bg-zinc-900/30 p-4 rounded text-center">
                            <div className="text-[10px] text-zinc-500 uppercase tracking-widest">Active Training</div>
                            <div className="text-xl font-bold text-term-green">{users.filter(u => u.score > 0).length}</div>
                        </div>
                        <div className="border border-zinc-800 bg-zinc-900/30 p-4 rounded text-center">
                            <div className="text-[10px] text-zinc-500 uppercase tracking-widest">Zero Progress</div>
                            <div className="text-xl font-bold text-term-red">{users.filter(u => u.score === 0).length}</div>
                        </div>
                        <div className="border border-zinc-800 bg-zinc-900/30 p-4 rounded text-center">
                            <div className="text-[10px] text-zinc-500 uppercase tracking-widest">Top Score</div>
                            <div className="text-xl font-bold text-term-gold">{users.length > 0 ? users[0].score : 0}</div>
                        </div>
                    </div>

                    {/* LEADERBOARD TABLE */}
                    <div className="border border-zinc-800 rounded bg-zinc-900/10 overflow-x-auto">
                        <table className="w-full text-left border-collapse min-w-[600px]">
                            <thead>
                                <tr className="border-b border-zinc-800 text-[10px] uppercase tracking-widest text-zinc-500 bg-black/40">
                                    <th className="p-3 w-16 text-center">Rank</th>
                                    <th className="p-3">Operative</th>
                                    <th className="p-3 text-center">Role</th>
                                    <th className="p-3 text-center">Modules Completed</th>
                                    <th className="p-3 text-right">Last Active</th>
                                </tr>
                            </thead>
                            <tbody>
                                {users.map((user, index) => (
                                    <React.Fragment key={user.id}>
                                        <tr
                                            onClick={() => toggleExpand(user.id)}
                                            className="border-b border-zinc-800/50 hover:bg-zinc-800/30 transition-colors cursor-pointer"
                                        >
                                            <td className="p-3 text-center">
                                                <span className={`text-xs font-bold ${index === 0 ? 'text-term-gold' : index < 3 ? 'text-white' : 'text-zinc-600'}`}>
                                                    #{index + 1}
                                                </span>
                                            </td>
                                            <td className="p-3 font-bold text-sm text-zinc-300">
                                                {user.username || 'UNKNOWN_ASSET'}
                                                {user.id === '5abcdeb3-0d75-4201-ba36-2f0c9d7a41ff' && <span className="ml-2 text-[10px] text-term-red border border-term-red px-1">[ ARCHITECT ]</span>}
                                            </td>
                                            <td className="p-3 text-center text-xs">
                                                <span className={`px-2 py-1 rounded text-[10px] uppercase ${user.role === 'Sovereign' ? 'bg-term-green/10 text-term-green border border-term-green/30' : 'bg-zinc-800 text-zinc-400'}`}>
                                                    {user.role}
                                                </span>
                                            </td>
                                            <td className="p-3 text-center flex items-center justify-center gap-2">
                                                <span className={`font-mono font-bold ${user.score > 0 ? 'text-term-green' : 'text-zinc-600'}`}>
                                                    {user.score}
                                                </span>
                                                <span className="text-[10px] border border-zinc-700 text-zinc-500 px-1 hover:text-white hover:border-zinc-500">
                                                    {expandedUserId === user.id ? '[-]' : '[+]'}
                                                </span>
                                            </td>
                                            <td className="p-3 text-right text-xs font-mono text-zinc-500">
                                                {formatDate(user.lastActive)}
                                            </td>
                                        </tr>
                                        {expandedUserId === user.id && (
                                            <tr>
                                                <td colSpan="5" className="p-0 border-b border-zinc-800">
                                                    {renderUserProgress(user)}
                                                </td>
                                            </tr>
                                        )}
                                    </React.Fragment>
                                ))}
                                {users.length === 0 && (
                                    <tr>
                                        <td colSpan="5" className="p-8 text-center text-zinc-500 text-xs">NO OPERATIVES FOUND</td>
                                    </tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProgressDashboard />);
    </script>
</body>

</html>

