<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Interface // Command</title>

    <!-- NEW V3 TYPOGRAPHY (NEON LEGACY) -->
    
    
    

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'void': '#05010a',
                        'command-bg': '#050505',
                        'term-green': '#22c55e',
                        'rika-purple': '#8b5cf6',
                        'ai-red': '#ef4444',
                        'command-amber': '#d97706',
                    },

                    fontFamily: {
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'monospace'],
                        sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif']
                    },

                    
                    animation: {
                        'scanline': 'scanline 8s linear infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-up': 'fadeUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        scanline: {
                            '0%': { transform: 'translateY(-100%)' },
                            '100%': { transform: 'translateY(100%)' }
                        },
                        fadeUp: {
                            '0%': { opacity: '0', transform: 'translateY(15px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #05010a;
            color: #e4e4e7;
            overflow-x: hidden;
        }

        .scanline {
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.3) 50%, rgba(0, 0, 0, 0.3));
            background-size: 100% 4px;
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 10;
            opacity: 0.15;
        }

        .crt-vignette {
            background: radial-gradient(circle at center, transparent 60%, rgba(0, 0, 0, 0.9) 100%);
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 9;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background-color: #05010a;
            border-left: 1px solid rgba(34, 197, 94, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: #22c55e;
            border-radius: 0px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ffffff;
        }

        /* Command Node Base Aesthetics */
        .cmd-node {
            background: rgba(5, 5, 5, 0.9);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .cmd-node::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        /* Standard Green Nodes */
        .node-standard {
            border: 1px solid rgba(34, 197, 94, 0.4);
        }

        .node-standard:hover {
            border-color: #22c55e;
            box-shadow: 0 0 35px rgba(34, 197, 94, 0.25);
            background: rgba(34, 197, 94, 0.05);
        }

        .node-standard:hover::before {
            border-color: rgba(34, 197, 94, 0.2);
            transform: scale(0.96);
        }

        /* Rika Purple Nodes */
        .node-rika {
            border: 1px solid rgba(139, 92, 246, 0.5);
        }

        .node-rika:hover {
            border-color: #8b5cf6;
            box-shadow: 0 0 35px rgba(139, 92, 246, 0.3);
            background: rgba(139, 92, 246, 0.05);
        }

        .node-rika:hover::before {
            border-color: rgba(139, 92, 246, 0.2);
            transform: scale(0.96);
        }

        /* AI Red Nodes */
        .node-ai {
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

        .node-ai:hover {
            border-color: #ef4444;
            box-shadow: 0 0 35px rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.05);
        }

        .node-ai:hover::before {
            border-color: rgba(239, 68, 68, 0.2);
            transform: scale(0.96);
        }

        /* Lockout Styling via JS */
        .node-locked {
            opacity: 0.4;
            filter: grayscale(100%);
            border-color: #333 !important;
            box-shadow: none !important;
            background: #000 !important;
            cursor: not-allowed;
            transform: none !important;
        }

        .node-locked::before {
            display: none;
        }
    </style>

    <!-- MSX SIDEBAR INJECTION -->
    <script type="module" src="../assets/js/sidebar.js"></script>
</head>

<body
    class="antialiased selection:bg-term-green selection:text-black pb-24 min-h-screen flex flex-col items-center pl-0 lg:pl-[256px]">
    <div class="scanline"></div>
    <div class="crt-vignette"></div>

    <main class="w-full max-w-7xl px-4 flex flex-col gap-12 mt-20 md:mt-28 relative z-20">

        <!-- HEADER -->
        <header
            class="w-full border-b-2 border-term-green/40 pb-8 text-center md:text-left flex flex-col md:flex-row md:items-end justify-between gap-6 animate-fade-up">
            <div>
                <h1
                    class="text-5xl md:text-7xl font-black font-mono tracking-[0.15em] text-white uppercase  mb-2">
                    CENTRAL COMMAND
                </h1>
                <p class="font-mono text-sm md:text-base text-term-green tracking-[0.2em] uppercase font-bold">
                    > SYSTEM DIRECTORY ROUTING <br class="md:hidden"> // CLEARANCE ENFORCED
                </p>
            </div>
            <div class="md:text-right font-mono text-xs md:text-sm tracking-widest text-term-green/70">
                <span class="inline-block p-2 border border-term-green/30 bg-term-green/10">
                    STATUS: <span class="text-white font-bold animate-pulse">LIVE [●]</span>
                </span>
            </div>
        </header>

        <!-- CORE V3 MODULE GRID -->
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 w-full">

            <!-- DOSSIER -->
            <a href="profile/" data-required-role="OBSERVER"
                class="cmd-node node-standard p-8 min-h-[180px] relative group flex flex-col justify-center transition-all animate-fade-up"
                style="animation-delay: 0.1s;">
                <span
                    class="font-mono text-xs font-bold text-term-green/60 absolute top-4 left-4 tracking-widest group-hover:text-term-green">DIR_01</span>
                <div class="mt-6 z-10 relative">
                    <h2
                        class="node-title text-2xl md:text-3xl font-bold font-mono text-white tracking-[0.1em] mb-2 group-hover:text-term-green transition-colors uppercase">
                        Sovereign Dossier</h2>
                    <p class="font-mono font-bold text-sm text-term-green/70 tracking-wide uppercase">Hardware & Loadout
                    </p>
                </div>
            </a>

            <!-- SYNDICATE -->
            <a href="network/" data-required-role="OBSERVER"
                class="cmd-node node-standard p-8 min-h-[180px] relative group flex flex-col justify-center transition-all animate-fade-up"
                style="animation-delay: 0.2s;">
                <span
                    class="font-mono text-xs font-bold text-term-green/60 absolute top-4 left-4 tracking-widest group-hover:text-term-green">DIR_02</span>
                <div class="mt-6 z-10 relative">
                    <h2
                        class="node-title text-2xl md:text-3xl font-bold font-mono text-white tracking-[0.1em] mb-2 group-hover:text-term-green transition-colors uppercase">
                        The Syndicate</h2>
                    <p class="font-mono font-bold text-sm text-term-green/70 tracking-wide uppercase">Vanguard
                        Invitations</p>
                </div>
            </a>

            <!-- LEDGER -->
            <a href="lexicon/" data-required-role="OBSERVER"
                class="cmd-node node-standard p-8 min-h-[180px] relative group flex flex-col justify-center transition-all animate-fade-up"
                style="animation-delay: 0.3s;">
                <span
                    class="font-mono text-xs font-bold text-term-green/60 absolute top-4 left-4 tracking-widest group-hover:text-term-green">DIR_03</span>
                <div class="mt-6 z-10 relative">
                    <h2
                        class="node-title text-2xl md:text-3xl font-bold font-mono text-white tracking-[0.1em] mb-2 group-hover:text-term-green transition-colors uppercase">
                        Sovereign Ledger</h2>
                    <p class="font-mono font-bold text-sm text-term-green/70 tracking-wide uppercase">Doctrinal Database
                    </p>
                </div>
            </a>

            <!-- CODEX -->
            <a href="codex/" data-required-role="OBSERVER"
                class="cmd-node node-standard p-8 min-h-[180px] relative group flex flex-col justify-center transition-all animate-fade-up"
                style="animation-delay: 0.4s;">
                <span
                    class="font-mono text-xs font-bold text-term-green/60 absolute top-4 left-4 tracking-widest group-hover:text-term-green">DIR_04</span>
                <div class="mt-6 z-10 relative">
                    <h2
                        class="node-title text-2xl md:text-3xl font-bold font-mono text-white tracking-[0.1em] mb-2 group-hover:text-term-green transition-colors uppercase">
                        The Codex</h2>
                    <p class="font-mono font-bold text-sm text-term-green/70 tracking-wide uppercase">Field Manuals</p>
                </div>
            </a>

            <!-- TERMINAL -->
            <a href="terminal/" data-required-role="NONE"
                class="cmd-node node-standard p-8 min-h-[180px] relative group flex flex-col justify-center transition-all animate-fade-up"
                style="animation-delay: 0.5s;">
                <span
                    class="font-mono text-xs font-bold text-term-green/60 absolute top-4 left-4 tracking-widest group-hover:text-term-green">DIR_05</span>
                <div class="mt-6 z-10 relative">
                    <h2
                        class="node-title text-2xl md:text-3xl font-bold font-mono text-white tracking-[0.1em] mb-2 group-hover:text-term-green transition-colors uppercase">
                        Command Link</h2>
                    <p class="font-mono font-bold text-sm text-term-green/70 tracking-wide uppercase">Secure Terminal
                        Access</p>
                </div>
            </a>

            <!-- FORGE (OPERATOR/ARCHIVIST) -->
            <a href="../synth/makemyown/" data-required-role="OPERATOR"
                class="cmd-node node-ai p-8 min-h-[180px] relative group flex flex-col justify-center transition-all animate-fade-up"
                style="animation-delay: 0.6s;">
                <span
                    class="font-mono text-xs font-bold text-ai-red/60 absolute top-4 left-4 tracking-widest group-hover:text-ai-red">SYNTH_01</span>
                <div class="mt-6 z-10 relative">
                    <h2
                        class="node-title text-2xl md:text-3xl font-bold font-mono text-white tracking-[0.1em] mb-2 group-hover:text-ai-red transition-colors uppercase">
                        Auditor Forge</h2>
                    <p class="font-mono font-bold text-sm text-ai-red/70 tracking-wide uppercase">Build Exoskeleton</p>
                </div>
            </a>

            <!-- INTELLIGENCE (OPERATOR/ARCHIVIST) -->
            <a href="../synth/rika/" data-required-role="OPERATOR"
                class="cmd-node node-rika lg:col-span-3 p-10 min-h-[180px] relative group flex flex-col md:flex-row items-center justify-between text-center md:text-left transition-all animate-fade-up"
                style="animation-delay: 0.7s;">
                <div class="mb-4 md:mb-0 z-10 relative">
                    <span
                        class="font-mono text-xs font-bold text-rika-purple/80 tracking-[0.2em] mb-2 block group-hover:animate-pulse">SYNTH_02
                        // ONLINE</span>
                    <h2
                        class="node-title text-3xl md:text-4xl font-bold font-mono text-white tracking-[0.1em] mb-2 group-hover:text-rika-purple transition-colors uppercase">
                        Intelligence Terminal</h2>
                    <p class="font-mono font-bold text-sm text-rika-purple/80 tracking-wide uppercase">Forensic
                        Synthesizer [ RIKA ]</p>
                </div>
                <div class="z-10 relative mt-4 md:mt-0">
                    <span
                        class="inline-block border-2 border-rika-purple text-rika-purple bg-rika-purple/10 px-6 py-3 font-bold tracking-widest font-mono text-sm group-hover:bg-rika-purple group-hover:text-white transition-colors uppercase">
                        INITIALIZE LINK
                    </span>
                </div>
            </a>

        </section>

        <!-- FOOTER -->
        <footer
            class="mt-16 w-full px-4 relative z-20 border-t-2 border-term-green/30 pt-6 animate-fade-up flex flex-col md:flex-row justify-between items-center"
            style="animation-delay: 0.8s;">
            <p class="font-mono text-xs text-term-green/60 uppercase tracking-widest mb-4 md:mb-0 font-bold">
                FSK-RIKA-1.1 // CORE V3
            </p>
            <p class="font-mono text-xs text-term-green/60 uppercase tracking-widest font-bold">
                ENCRYPTION: <span class="text-white">VALIDATED</span>
            </p>
        </footer>
    </main>

    <!-- RBAC BUTTON LOCKOUT LOGIC -->
    <script type="module">
        import { supabase } from '../assets/js/supabaseClient.js';

        document.addEventListener('DOMContentLoaded', async () => {
            let userRole = 'VISITOR';
            let userRolesList = [];

            // 1. Fetch Session & Profile
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('role, roles')
                    .eq('id', session.user.id)
                    .single();

                if (profile) {
                    if (profile.role) userRolesList.push(profile.role.toUpperCase());
                    if (profile.roles && Array.isArray(profile.roles)) {
                        userRolesList.push(...profile.roles.map(r => r.toUpperCase()));
                    }
                    if (userRolesList.length > 0) {
                        userRole = userRolesList.includes('SOVEREIGN') ? 'SOVEREIGN' : userRolesList[0];
                    }
                } else {
                    userRole = 'OBSERVER'; // Fallback if record somehow drifted but auth is active
                }
            }

            // 2. Lockout Logic
            const commandNodes = document.querySelectorAll('.cmd-node');
            commandNodes.forEach(node => {
                const reqRole = node.getAttribute('data-required-role');
                if (reqRole && reqRole !== 'NONE') {

                    let hasAccess = false;

                    // Absolute Overrides
                    if (userRolesList.includes('SOVEREIGN') || userRolesList.includes('ARCHIVIST') || userRolesList.includes('OPERATOR')) {
                        hasAccess = true;
                    }
                    // Observer Checking
                    else if (reqRole === 'OBSERVER' && (userRole === 'OBSERVER' || userRole === 'VISITOR')) {
                        // Enforce session for OBSERVER.
                        if (session) hasAccess = true;
                    }

                    if (!hasAccess) {
                        // Apply CSS Lockout styling
                        node.classList.add('node-locked');
                        node.classList.remove('node-standard', 'node-ai', 'node-rika');

                        // Prevent Navigation
                        node.onclick = (e) => {
                            e.preventDefault();
                            const title = node.querySelector('.node-title');
                            const origText = title.innerText;
                            const origColor = title.classList.contains('text-white');

                            // Glitch effect on click
                            title.innerText = "[ LACK CLEARANCE ]";
                            title.classList.replace('text-white', 'text-command-red');
                            title.classList.add('animate-pulse');

                            setTimeout(() => {
                                title.innerText = origText;
                                title.classList.replace('text-command-red', 'text-white');
                                title.classList.remove('animate-pulse');
                            }, 1000);
                        };
                    }
                }
            });
        });
    </script>
</body>

</html>