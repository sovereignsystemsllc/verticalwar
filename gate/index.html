<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECURE SECURE // PHALANX</title>

    <!-- PURE V3 STACK: TAILWIND CDN ONLY -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'term-black': '#050505', 'term-green': '#00ff33' },
                    fontFamily: { mono: ['Courier New', 'monospace'] }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050505;
            color: #00ff33;
            cursor: crosshair;
        }

        .glass-panel {
            background: rgba(10, 20, 10, 0.9);
            border: 1px solid #00ff33;
            box-shadow: 0 0 15px rgba(0, 255, 51, 0.1);
            transition: all 0.3s ease;
        }

        .input-heavy {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 255, 51, 0.3);
            color: white;
            padding: 1rem;
            width: 100%;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .input-heavy:focus {
            border-color: #00ff33;
            box-shadow: 0 0 15px rgba(0, 255, 51, 0.3);
            background: rgba(0, 0, 0, 0.9);
        }

        /* INPUT AUTOFILL HACK */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #050505 inset !important;
            -webkit-text-fill-color: #00ff33 !important;
            caret-color: #00ff33;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #050505;
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff33;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #fff;
        }

        .tab-active {
            color: #fff;
            border-bottom: 2px solid #00ff33;
        }

        .tab-inactive {
            color: rgba(0, 255, 51, 0.5);
            border-bottom: 2px solid transparent;
            hover: color: #fff;
        }
    </style>
</head>

<body
    class="min-h-screen w-full font-mono flex flex-col justify-center items-center p-4 selection:bg-[#00ff33] selection:text-black">

    <!-- PURE V3 MINIMAL NAV -->
    <a href="../"
        class="fixed top-6 left-6 text-[10px] md:text-sm font-bold text-[#00ff33] hover:text-white transition-colors tracking-[0.2em] border border-[#00ff33]/50 px-4 py-2 hover:bg-[#00ff33]/20 z-50">
        [ RETURN TO MATRIX ]
    </a>

    <!-- TERMINAL WINDOW -->
    <div class="relative z-10 w-full max-w-[500px] glass-panel p-8 md:p-12 mt-16">

        <!-- LOGO / HEADER -->
        <div class="text-center mb-8 border-b border-[#00ff33]/30 pb-6">
            <h1
                class="text-3xl md:text-4xl font-bold tracking-[0.2em] text-[#00ff33] uppercase drop-shadow-[0_0_8px_rgba(0,255,51,0.5)] mb-2">
                ACCESS GATE</h1>
            <div class="text-[10px] text-[#00ff33]/70 uppercase tracking-widest animate-pulse">
                // SECURE UPLINK ESTABLISHED
            </div>
        </div>

        <!-- TABS -->
        <div class="flex mb-8 text-xs md:text-sm tracking-widest uppercase">
            <button id="tab-login"
                class="flex-1 pb-3 text-center transition-colors focus:outline-none tab-active font-bold">LOGIN</button>
            <button id="tab-register"
                class="flex-1 pb-3 text-center transition-colors focus:outline-none tab-inactive hover:text-[#00ff33]">SIGN
                UP</button>
        </div>

        <!-- LOGIN FORM -->
        <form id="login-form" class="space-y-6 block">
            <div class="group">
                <label
                    class="block text-[10px] text-[#00ff33]/70 uppercase tracking-widest mb-2 group-focus-within:text-white transition-colors">Email
                    Address</label>
                <input type="email" id="email-login" class="input-heavy placeholder-[#00ff33]/20"
                    placeholder="DECRYPT@SYS.COM" required>
            </div>

            <div class="group">
                <label
                    class="block text-[10px] text-[#00ff33]/70 uppercase tracking-widest mb-2 group-focus-within:text-white transition-colors">Passcode</label>
                <input type="password" id="password-login" class="input-heavy placeholder-[#00ff33]/20"
                    placeholder="••••••••" required>
            </div>

            <button type="submit"
                class="w-full mt-6 bg-[#00ff33]/10 border border-[#00ff33] text-[#00ff33] hover:bg-[#00ff33] hover:text-black py-4 text-base md:text-xl font-bold tracking-[0.2em] transition-all uppercase drop-shadow-[0_0_8px_rgba(0,255,51,0.5)]">
                [ INITIATE UPLINK ]
            </button>

            <div class="text-center pt-4 text-[10px] text-[#00ff33]/60 tracking-widest">
                <a href="#" id="link-recovery"
                    class="hover:text-white transition-colors uppercase border-b border-transparent hover:border-white pb-1">Forgot
                    Passcode?</a>
            </div>
        </form>

        <!-- REGISTER FORM -->
        <form id="register-form" class="space-y-6 hidden">
            <div class="group">
                <label
                    class="block text-[10px] text-[#00ff33]/70 uppercase tracking-widest mb-2 group-focus-within:text-white transition-colors">Callsign
                    (Optional)</label>
                <input type="text" id="callsign-register" class="input-heavy placeholder-[#00ff33]/20"
                    placeholder="OPERATOR_01">
            </div>

            <div class="group">
                <label
                    class="block text-[10px] text-[#00ff33]/70 uppercase tracking-widest mb-2 group-focus-within:text-white transition-colors">Email
                    Address</label>
                <input type="email" id="email-register" class="input-heavy placeholder-[#00ff33]/20"
                    placeholder="DECRYPT@SYS.COM" required>
            </div>

            <div class="group">
                <label
                    class="block text-[10px] text-[#00ff33]/70 uppercase tracking-widest mb-2 group-focus-within:text-white transition-colors">Create
                    Passcode</label>
                <input type="password" id="password-register" class="input-heavy placeholder-[#00ff33]/20"
                    placeholder="••••••••" required>
            </div>

            <button type="submit"
                class="w-full mt-6 bg-black border border-white text-white hover:border-[#00ff33] hover:text-[#00ff33] py-4 text-base md:text-xl font-bold tracking-[0.2em] transition-all uppercase">
                [ ESTABLISH IDENTITY ]
            </button>
        </form>

        <!-- RECOVERY FORM -->
        <form id="recovery-form" class="space-y-6 hidden">
            <div class="text-center text-xs text-[#00ff33]/80 mb-6 leading-relaxed">
                ENTER EMAIL TO RECEIVE SECURE RESET LINK.
            </div>

            <div class="group">
                <label
                    class="block text-[10px] text-[#00ff33]/70 uppercase tracking-widest mb-2 group-focus-within:text-white transition-colors">Email
                    Address</label>
                <input type="email" id="email-recovery"
                    class="input-heavy !border-red-500/50 focus:!border-red-500 !text-red-500 placeholder-red-500/30"
                    placeholder="DECRYPT@SYS.COM" required>
            </div>

            <button type="submit"
                class="w-full mt-6 bg-red-500/10 border border-red-500 text-red-500 hover:bg-red-500 hover:text-black py-4 text-base md:text-xl font-bold tracking-[0.2em] transition-all uppercase drop-shadow-[0_0_8px_rgba(239,68,68,0.5)]">
                [ TRANSMIT REQUEST ]
            </button>

            <div class="text-center pt-4">
                <button type="button" id="cancel-recovery"
                    class="text-[10px] text-[#00ff33]/60 hover:text-white uppercase tracking-widest border-b border-transparent hover:border-white pb-1">
                    < ABORT RECOVERY </button>
            </div>
        </form>

        <!-- RESET FORM -->
        <form id="reset-form" class="space-y-6 hidden">
            <div class="text-center text-xs text-[#00ff33] mb-6 animate-pulse">
                /// CHANNEL OVERRIDE ACTIVE ///<br>ENTER NEW PASSCODE
            </div>

            <div class="group">
                <label
                    class="block text-[10px] text-[#00ff33]/70 uppercase tracking-widest mb-2 group-focus-within:text-white transition-colors">New
                    Passcode</label>
                <input type="password" id="password-reset" class="input-heavy placeholder-[#00ff33]/20"
                    placeholder="••••••••" required>
            </div>

            <button type="submit"
                class="w-full mt-6 bg-[#00ff33]/10 border border-[#00ff33] text-[#00ff33] hover:bg-[#00ff33] hover:text-black py-4 text-base md:text-xl font-bold tracking-[0.2em] transition-all uppercase drop-shadow-[0_0_8px_rgba(0,255,51,0.5)]">
                [ OVERWRITE PASSCODE ]
            </button>
        </form>

        <!-- STATUS OUTPUT -->
        <div id="status-output"
            class="mt-6 text-center min-h-[1.5rem] tracking-widest text-[10px] uppercase text-red-500 opacity-0 transition-opacity duration-300">
            // SYSTEM_READY
        </div>

    </div>

    <!-- MAIN SUPABASE LOGIC (PRESERVED) -->
    <script type="module">
        import { supabase } from '../assets/js/supabaseClient.js';

        // ELEMENTS
        const tabLogin = document.getElementById('tab-login');
        const tabRegister = document.getElementById('tab-register');
        const formLogin = document.getElementById('login-form');
        const formRegister = document.getElementById('register-form');
        const statusOutput = document.getElementById('status-output');

        function showStatus(msg, colorClass) {
            statusOutput.className = `mt-6 text-center min-h-[1.5rem] tracking-widest text-[10px] uppercase transition-opacity duration-300 ${colorClass}`;
            statusOutput.innerText = msg;
            statusOutput.style.opacity = '1';
        }

        // AUTO CHECK SESSION
        (async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                let callsign = "OPERATOR";
                const { data: profile } = await supabase.from('profiles').select('username').eq('id', session.user.id).single();
                if (profile && profile.username) callsign = profile.username;

                document.querySelector('h1').innerText = "LINK ESTABLISHED";
                document.querySelector('h1').nextElementSibling.innerText = `// ${callsign}`;
                tabLogin.parentElement.style.display = 'none';

                formLogin.innerHTML = `
                    <div class="text-center space-y-6">
                        <p class="text-xs text-[#00ff33] mb-8 tracking-widest animate-pulse">/// IDENTITY CONFIRMED ///</p>
                        <a href="../cmd/" class="block w-full bg-[#00ff33]/10 border border-[#00ff33] text-[#00ff33] hover:bg-[#00ff33] hover:text-black py-4 text-base md:text-xl font-bold tracking-[0.2em] transition-all uppercase drop-shadow-[0_0_8px_rgba(0,255,51,0.5)]">
                            [ ENTER HUB ]
                        </a>
                        <button id="gate-logout" class="mt-6 w-full text-red-500/70 hover:text-red-500 text-[10px] tracking-widest transition-colors uppercase">
                            [ SEVER CONNECTION ]
                        </button>
                    </div>
                `;

                document.getElementById('gate-logout')?.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await supabase.auth.signOut();
                    window.location.reload();
                });

                const urlParams = new URLSearchParams(window.location.search);
                const nextUrl = urlParams.get('next');
                if (nextUrl) setTimeout(() => window.location.href = nextUrl, 800);
            } else {
                const urlParams = new URLSearchParams(window.location.search);
                const nextParam = urlParams.get('next');
                if (nextParam) {
                    sessionStorage.setItem('sov_redirect', nextParam);
                } else if (document.referrer && !document.referrer.includes('/gate/')) {
                    try {
                        const refUrl = new URL(document.referrer);
                        if (refUrl.origin === window.location.origin) {
                            sessionStorage.setItem('sov_redirect', refUrl.pathname + refUrl.search);
                        }
                    } catch (e) { }
                }
            }
        })();

        // TABS
        tabLogin.addEventListener('click', () => {
            formLogin.classList.remove('hidden');
            formRegister.classList.add('hidden');
            tabLogin.className = 'flex-1 pb-3 text-center transition-colors focus:outline-none tab-active font-bold';
            tabRegister.className = 'flex-1 pb-3 text-center transition-colors focus:outline-none tab-inactive hover:text-[#00ff33]';
            statusOutput.style.opacity = '0';
        });

        tabRegister.addEventListener('click', () => {
            formLogin.classList.add('hidden');
            formRegister.classList.remove('hidden');
            tabRegister.className = 'flex-1 pb-3 text-center transition-colors focus:outline-none tab-active font-bold';
            tabLogin.className = 'flex-1 pb-3 text-center transition-colors focus:outline-none tab-inactive hover:text-[#00ff33]';
            statusOutput.style.opacity = '0';
        });

        // ACTION: LOGIN
        formLogin.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email-login').value;
            const password = document.getElementById('password-login').value;

            showStatus(">> VERIFYING CREDENTIALS...", "text-yellow-500");

            const { error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                showStatus(`[ ERROR: ${error.message} ]`, "text-red-500 font-bold");
            } else {
                showStatus(">> ACCESS GRANTED. ROUTING...", "text-[#00ff33] animate-pulse");
                let nextUrl = new URLSearchParams(window.location.search).get('next') || sessionStorage.getItem('sov_redirect');
                if (nextUrl) sessionStorage.removeItem('sov_redirect');
                setTimeout(() => window.location.href = nextUrl ? nextUrl : '../cmd/', 600);
            }
        });

        // ACTION: REGISTER
        formRegister.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email-register').value;
            const password = document.getElementById('password-register').value;
            const callsign = document.getElementById('callsign-register').value || "Recruit";

            showStatus(">> FORGING NEW PROXY...", "text-yellow-500");

            const { error } = await supabase.auth.signUp({
                email, password,
                options: {
                    emailRedirectTo: window.location.origin + '/gate/',
                    data: { username: callsign, role: 'Observer' }
                }
            });

            if (error) {
                showStatus(`[ ERROR: ${error.message} ]`, "text-red-500 font-bold");
            } else {
                showStatus(">> PROXY CREATED. VERIFY SECURE EMAIL CONFIRMATION.", "text-[#00ff33]");
            }
        });

        // RECOVERY FLOW
        const linkRecovery = document.getElementById('link-recovery');
        const formRecovery = document.getElementById('recovery-form');
        const btnCancelRecovery = document.getElementById('cancel-recovery');
        const formReset = document.getElementById('reset-form');

        if (linkRecovery) {
            linkRecovery.addEventListener('click', (e) => {
                e.preventDefault();
                formLogin.classList.add('hidden');
                formRecovery.classList.remove('hidden');
                document.querySelector('h1').innerText = "RECOVERY";
                statusOutput.style.opacity = '0';
            });
        }

        if (btnCancelRecovery) {
            btnCancelRecovery.addEventListener('click', (e) => {
                e.preventDefault();
                formRecovery.classList.add('hidden');
                formLogin.classList.remove('hidden');
                document.querySelector('h1').innerText = "ACCESS GATE";
                statusOutput.style.opacity = '0';
            });
        }

        if (formRecovery) {
            formRecovery.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email-recovery').value;
                showStatus(">> BROADCASTING RESET SIGNAL...", "text-yellow-500 animate-pulse");

                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/gate/?mode=reset',
                });

                if (error) showStatus(`[ ERROR: ${error.message} ]`, "text-red-500");
                else showStatus(">> RESET SIGNAL SENT. CHECK INBOX.", "text-[#00ff33]");
            });
        }

        // RESET URL PARAM
        if (new URLSearchParams(window.location.search).get('mode') === 'reset') {
            formLogin.classList.add('hidden');
            formReset.classList.remove('hidden');
            document.querySelector('h1').innerText = "NEW PASSCODE";
            tabLogin.parentElement.style.display = 'none';
        }

        if (formReset) {
            formReset.addEventListener('submit', async (e) => {
                e.preventDefault();
                showStatus(">> FLASHING NEW PROTOCOL...", "text-yellow-500 animate-pulse");
                const { error } = await supabase.auth.updateUser({ password: document.getElementById('password-reset').value });

                if (error) showStatus(`[ ERROR: ${error.message} ]`, "text-red-500");
                else {
                    showStatus(">> PROTOCOL FLASHED. REDIRECTING...", "text-[#00ff33]");
                    setTimeout(() => window.location.href = '../cmd/', 1500);
                }
            });
        }
    </script>
</body>

</html>