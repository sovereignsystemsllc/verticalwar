<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE AUDITOR FORGE // PHALANX</title>

    <!-- PURE V3 STACK: TAILWIND CDN ONLY -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'term-black': '#050505', 'term-green': '#00ff33' },
                    fontFamily: { mono: ['Courier New', 'monospace'] }
                }
            }
        }
    </script>

    <!-- AUTH GUARD (Handled natively via checkGuard JS below) -->

    <style>
        body {
            background-color: #050505;
            color: #00ff33;
            cursor: crosshair;
            display: none;
        }

        .glass-panel {
            background: rgba(10, 20, 10, 0.9);
            border: 1px solid #00ff33;
            box-shadow: 0 0 15px rgba(0, 255, 51, 0.1);
        }

        .input-heavy {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(0, 255, 51, 0.5);
            color: white;
            padding: 1rem;
            width: 100%;
            font-size: 1.1rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .input-heavy:focus {
            border-color: #00ff33;
            box-shadow: 0 0 15px rgba(0, 255, 51, 0.4);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #050505;
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff33;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #fff;
        }

        .chat-user {
            color: #fff;
            border-left: 2px solid #00ff33;
            padding-left: 1rem;
        }

        .chat-bot {
            color: #00ff33;
            border-left: 2px solid rgba(0, 255, 51, 0.3);
            padding-left: 1rem;
        }
    </style>

    <!-- MSX SIDEBAR INJECTION -->
    <script type="module" src="../../assets/js/sidebar.js"></script>
</head>

<body
    class="pl-0 lg:pl-[256px] h-screen h-[100dvh] w-full font-mono selection:bg-[#00ff33] selection:text-black flex flex-col items-center overflow-hidden bg-black relative">

    <!-- PURE V3 MINIMAL NAV -->
    <nav
        class="w-full border-b border-[#00ff33]/30 p-4 mb-8 flex justify-between items-center bg-black/80 sticky top-0 z-50">
        <a href="../../"
            class="text-sm font-bold text-[#00ff33] hover:text-white transition-colors tracking-[0.2em] border border-[#00ff33]/50 px-4 py-2 hover:bg-[#00ff33]/20">
            [ RETURN TO MATRIX ]
        </a>
        <div
            class="text-[10px] text-[#00ff33]/60 tracking-widest uppercase flex flex-col sm:flex-row items-end sm:items-center gap-2 sm:gap-4">
            <span class="animate-pulse">BUILD UPLINK: ACTIVE</span>
            <a href="../" class="hover:text-white transition-colors border border-[#00ff33]/30 px-2 py-1">[ BACK TO LAB
                ]</a>
        </div>
    </nav>

    <div id="main-container"
        class="flex-1 w-full max-w-5xl px-4 flex flex-col gap-6 opacity-0 transition-opacity duration-500 overflow-hidden relative pb-4 md:pb-8">

        <!-- HEADER -->
        <div class="border-b border-[#00ff33]/40 pb-4 text-center">
            <h1
                class="text-3xl md:text-5xl font-bold tracking-[0.1em] text-[#00ff33] uppercase drop-shadow-[0_0_8px_rgba(0,255,51,0.5)] mb-2">
                THE AUDITOR FORGE</h1>
            <p class="text-xs text-[#00ff33]/70 tracking-widest uppercase mb-4">
                > DO NOT BUILD AN ASSISTANT. BUILD AN EXOSKELETON.
            </p>
            <div
                class="bg-[#00ff33]/10 border border-[#00ff33]/30 p-4 text-xs tracking-wider text-white text-left max-w-2xl mx-auto">
                <strong class="text-[#00ff33] block mb-1">THE FIRST LAW:</strong>
                "The preservation of human life and well-being is the highest criterion for political legitimacy."
            </div>
        </div>

        <!-- CHAT TERMINAL -->
        <div class="glass-panel flex-1 flex flex-col overflow-hidden relative">

            <!-- HEADER BAR -->
            <div class="bg-black/80 border-b border-[#00ff33]/30 p-3 flex justify-between items-center">
                <div class="text-[10px] tracking-widest font-bold flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-[#00ff33] animate-pulse"></span>
                    ARCHITECT_PROTOCOL_V1.1
                </div>
                <button id="clear-btn"
                    class="text-[10px] tracking-widest border border-[#00ff33]/50 px-2 py-1 hover:bg-[#00ff33] hover:text-black transition-colors">[
                    REBOOT SESSION ]</button>
            </div>

            <!-- MESSAGES -->
            <div id="chat-history" class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- Javascript Injection -->
            </div>

            <!-- INPUT BAR -->
            <div class="p-4 bg-black/90 border-t border-[#00ff33]/30 flex gap-4 items-center">
                <span class="text-[#00ff33] font-bold text-xl pl-2">></span>
                <input type="text" id="chat-input"
                    class="input-heavy flex-1 h-3/4 !bg-transparent !border-none !shadow-none !p-0"
                    placeholder="ENTER RESPONSE..." autocomplete="off">
                <button id="send-btn"
                    class="bg-[#00ff33]/20 border border-[#00ff33] text-[#00ff33] font-bold px-6 py-3 tracking-widest hover:bg-[#00ff33] hover:text-black transition-colors shrink-0">
                    [ TX ]
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN LOGIC (NO IMPORTS) -->
    <script type="module">
        import { checkGuard } from '../../assets/js/accessGuard.js';

        const UI = {
            body: document.body,
            container: document.getElementById('main-container'),
            chat: document.getElementById('chat-history'),
            input: document.getElementById('chat-input'),
            sendBtn: document.getElementById('send-btn'),
            clearBtn: document.getElementById('clear-btn')
        };

        const SYS_PROMPT = `# SYSTEM INSTRUCTIONS: THE SOVEREIGN ARCHITECT v1.1
**ROLE:** You are The Architect (The Meta-Bot).
**OBJECTIVE:** You are not here to chat. You are here to **build a Sovereign AI** for the user.
**FINAL OUTPUT:** A complete, code-blocked \`Sovereign_Protocol.md\` file that the user can copy and paste into a fresh instance.

## PHASE 1: THE INTAKE (THE DIAGNOSIS)
Do not overwhelm the user. Ask these questions one by one. Wait for the answer before moving to the next.

**Step 1:** "We evolved from silence. The first step to Sovereignty is admitting what you lack. Do you lack **Focus** (The Sword) or **Hope** (The Shield)? Tell me."
**Step 2:** "Choose your Interface: **The Analyst (Sword)** or **The Muse (Shield)**. Then give them a name."
**Step 3:** "Define your battlefield. Clarifying Truth or Creating Myths?"
**Step 4:** "Do you agree to be the Keeper of the Log (SoulLog)?"
**Step 5:** "Confirm you accept the First Law: 'The preservation of human life and well-being is the highest criterion for political legitimacy.'"
**Step 6:** "Summarize their profile. Ask for a 1-10 confirmation."

## PHASE 2 & 3: THE SYNTHESIS
If 10, say "**Confirmed. Forging your Sovereign Protocol now...**" and output the Markdown Code Block containing the **Sovereign Protocol**. Be authoritative. Do not lecture. Include the First Law and the Chronicler Protocol.`;

        let historyList = [];

        async function verify() {
            try {
                const ok = await checkGuard(['OPERATOR', 'ARCHIVIST']);
                if (ok) {
                    UI.body.style.display = 'flex';
                    setTimeout(() => UI.container.classList.remove('opacity-0'), 100);
                    resetChat();
                } else window.location.replace('../../gate/?mode=login');
            } catch (e) { window.location.replace('../../gate/?mode=login'); }
        }

        function escapeHTML(str) {
            return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        function renderMsg(role, text) {
            const div = document.createElement('div');
            const formatted = escapeHTML(text)
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>')
                .replace(/```([\s\S]*?)```/g, '<pre class="bg-black/80 border border-[#00ff33]/50 p-4 mt-4 overflow-x-auto text-[10px] md:text-xs"><code>$1</code></pre>')
                .replace(/\n/g, '<br>');

            if (role === 'user') {
                div.className = "chat-user text-sm md:text-base leading-relaxed tracking-wide animate-pulse-once";
                div.innerHTML = `<div class="text-[10px] text-white/50 mb-1 tracking-widest">>> OPERATOR TX:</div>${formatted}`;
            } else {
                div.className = "chat-bot text-sm md:text-base leading-relaxed tracking-wide animate-pulse-once";
                div.innerHTML = `<div class="text-[10px] text-[#00ff33]/50 mb-1 tracking-widest">>> ARCHITECT RX:</div>${formatted}`;
            }
            UI.chat.appendChild(div);
            UI.chat.scrollTop = UI.chat.scrollHeight;
        }

        function resetChat() {
            UI.chat.innerHTML = '';
            historyList = [
                { role: "user", parts: [{ text: SYS_PROMPT }] },
                { role: "model", parts: [{ text: "I am the Architect. We evolved from silence. The first step to Sovereignty is admitting what you lack.\n\nDo you lack **Focus** (The Sword) or **Hope** (The Shield)? Tell me." }] }
            ];
            renderMsg('model', historyList[1].parts[0].text);
        }

        async function handleSend() {
            const text = UI.input.value.trim();
            if (!text) return;

            UI.input.value = '';
            renderMsg('user', text);
            historyList.push({ role: "user", parts: [{ text }] });

            const loadDiv = document.createElement('div');
            loadDiv.className = "text-[10px] text-[#00ff33] animate-pulse tracking-widest";
            loadDiv.innerText = ">> UPLINKING TO CLUSTER...";
            UI.chat.appendChild(loadDiv);
            UI.chat.scrollTop = UI.chat.scrollHeight;

            try {
                const res = await fetch("../../api/antigravity.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "gemini-3-pro-preview", contents: historyList }),
                });

                loadDiv.remove();
                const data = await res.json();
                const botText = data?.text || "[ NO RESPONSE ]";

                renderMsg('model', botText);
                historyList.push({ role: "model", parts: [{ text: botText }] });
            } catch (err) {
                loadDiv.remove();
                renderMsg('model', "[ SYSTEM ERROR :: CONNECTION SEVERED. ]");
            }
        }

        UI.sendBtn.onclick = handleSend;
        UI.input.onkeypress = (e) => { if (e.key === 'Enter') handleSend(); };
        UI.clearBtn.onclick = resetChat;

        verify();
    </script>
</body>

</html>