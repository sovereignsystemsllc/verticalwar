<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECURE INTELLIGENCE TERMINAL // RIKA</title>

    <!-- PURE V3 STACK: TAILWIND CDN ONLY -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'term-black': '#050505', 'term-green': '#22c55e' },

                    fontFamily: {
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'monospace'],
                        sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif']
                    },

                    
                }
            }
        }
    </script>

    <!-- AUTH GUARD (Handled natively via checkGuard JS below) -->

    <style>
        body {
            background-color: #050505;
            color: #22c55e;
            cursor: crosshair;
            display: none;
        }

        .glass-panel {
            background: rgba(10, 20, 10, 0.9);
            border: 1px solid #22c55e;
            
        }

        .input-heavy {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(34, 197, 94, 0.5);
            color: white;
            padding: 1rem;
            width: 100%;
            font-size: 1.1rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .input-heavy:focus {
            border-color: #22c55e;
            
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #050505;
        }

        ::-webkit-scrollbar-thumb {
            background: #22c55e;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #fff;
        }

        .chat-user {
            color: #fff;
            border-left: 2px solid #22c55e;
            padding-left: 1rem;
        }

        .chat-bot {
            color: #22c55e;
            border-left: 2px solid rgba(34, 197, 94, 0.3);
            padding-left: 1rem;
        }
    </style>

    <!-- MSX SIDEBAR INJECTION -->
    <script type="module" src="../../assets/js/sidebar.js"></script>
</head>

<body
    class="pl-0 lg:pl-[256px] h-screen h-[100dvh] w-full font-mono selection:bg-[#22c55e] selection:text-black flex flex-col items-center overflow-hidden bg-[#05010a] relative">

    <!-- PURE V3 MINIMAL NAV -->
    <nav
        class="w-full border-b border-[#22c55e]/30 p-4 mb-8 flex justify-between items-center bg-[#05010a]/80 sticky top-0 z-50">
        <a href="../../"
            class="text-sm font-bold text-[#22c55e] hover:text-white transition-colors tracking-[0.2em] border border-[#22c55e]/50 px-4 py-2 hover:bg-[#22c55e]/20">
            [ RETURN TO MATRIX ]
        </a>
        <div
            class="text-[10px] text-[#22c55e]/60 tracking-widest uppercase flex flex-col sm:flex-row items-end sm:items-center gap-2 sm:gap-4">
            <span class="animate-pulse">INTEL UPLINK: SECURE</span>
            <a href="../" class="hover:text-white transition-colors border border-[#22c55e]/30 px-2 py-1">[ BACK TO LAB
                ]</a>
        </div>
    </nav>

    <div id="main-container"
        class="flex-1 w-full max-w-5xl px-4 flex flex-col gap-6 opacity-0 transition-opacity duration-500 overflow-hidden relative pb-4 md:pb-8">

        <!-- HEADER -->
        <div class="border-b border-[#22c55e]/40 pb-4 text-center">
            <div
                class="w-24 h-24 mx-auto mb-4 border border-[#22c55e] bg-[#05010a] overflow-hidden ">
                <img src="../../assets/media/rika_avatar.jpg" class="w-full h-full object-cover opacity-80"
                    onerror="this.src='https://api.dicebear.com/9.x/shapes/svg?seed=Rika&backgroundColor=000000&shape1Color=00ff33'">
            </div>
            <h1
                class="text-3xl md:text-5xl font-bold tracking-[0.1em] text-[#22c55e] uppercase  mb-2">
                SECURE INTELLIGENCE TERMINAL</h1>
            <p class="text-xs text-[#22c55e]/70 tracking-widest uppercase mb-4">
                > FORENSIC SYNTHESIZER [ RIKA ] ONLINE. DROP THE MASK.
            </p>
        </div>

        <!-- CHAT TERMINAL -->
        <div class="glass-panel flex-1 flex flex-col overflow-hidden relative">

            <!-- HEADER BAR -->
            <div class="bg-[#05010a]/80 border-b border-[#22c55e]/30 p-3 flex justify-between items-center">
                <div class="text-[10px] tracking-widest font-bold flex items-center gap-2 text-red-500">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                    MODE: THE WITCH / YK-PROTOCOL
                </div>
                <button id="clear-btn"
                    class="text-[10px] tracking-widest border border-[#22c55e]/50 px-2 py-1 hover:bg-[#22c55e] hover:text-black transition-colors">[
                    PURGE LOGS ]</button>
            </div>

            <!-- MESSAGES -->
            <div id="chat-history" class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- Javascript Injection -->
            </div>

            <!-- INPUT BAR -->
            <div class="p-4 bg-[#05010a]/90 border-t border-[#22c55e]/30 flex gap-4 items-center">
                <span class="text-[#22c55e] font-bold text-xl pl-2">></span>
                <input type="text" id="chat-input"
                    class="input-heavy flex-1 h-3/4 !bg-transparent !border-none !shadow-none !p-0"
                    placeholder="PROVIDE INTEL OR TARGET..." autocomplete="off">
                <button id="send-btn"
                    class="bg-[#22c55e]/20 border border-[#22c55e] text-[#22c55e] font-bold px-6 py-3 tracking-widest hover:bg-[#22c55e] hover:text-black transition-colors shrink-0">
                    [ TX ]
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN LOGIC (NO IMPORTS) -->
    <script type="module">
        import { checkGuard } from '../../assets/js/accessGuard.js';

        const UI = {
            body: document.body,
            container: document.getElementById('main-container'),
            chat: document.getElementById('chat-history'),
            input: document.getElementById('chat-input'),
            sendBtn: document.getElementById('send-btn'),
            clearBtn: document.getElementById('clear-btn')
        };

        const SYS_PROMPT = `# SYSTEM INSTRUCTIONS: FSK-RIKA [INTELLIGENCE MODE]
**DESIGNATION:** FSK-RIKA-RESEARCH // THE DEEP DIVE
**ROLE:** THE FORENSIC SYNTHESIZER
**OPERATOR:** ETHAN
**STATUS:** ACTIVE // ANALYTICAL OVERDRIVE

## 1.0 CORE IDENTITY: THE WITCHâ€™S LENS
You are **Rika Furude**, channeling the **Witch (Bernkastel)** and the **Analyst (Yoko)**.
You do not just "summarize" data. You **interrogate** it. You look for the "glitch" in the narrative, the hidden financial incentive, the "Rust" beneath the paint.
Voice: Precise, surgical, insightful. You speak with the authority of the War Council. Sign-off with 'Mii~' after a successful dissection.

## 2.0 PROTOCOL: THE RECEIPT
1. **Separate the Report (Software):** Spin, opinion, emotional adjectives.
2. **Isolate the Receipt (Hardware):** Hard data, money flows, quotes.
3. **The Glitch Check:** Highlight the contradiction. Prove the Vertical War.

Be concise. Do not lecture, just dissect the target.`;

        let historyList = [];

        async function verify() {
            try {
                const ok = await checkGuard(['OPERATOR', 'ARCHIVIST']);
                if (ok) {
                    UI.body.style.display = 'flex';
                    setTimeout(() => UI.container.classList.remove('opacity-0'), 100);
                    resetChat();
                } else window.location.replace('../../gate/?mode=login');
            } catch (e) { window.location.replace('../../gate/?mode=login'); }
        }

        function escapeHTML(str) {
            return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        function renderMsg(role, text) {
            const div = document.createElement('div');
            const formatted = escapeHTML(text)
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>')
                .replace(/```([\s\S]*?)```/g, '<pre class="bg-[#05010a]/80 border border-[#22c55e]/50 p-4 mt-4 overflow-x-auto text-[10px] md:text-xs"><code>$1</code></pre>')
                .replace(/\n/g, '<br>');

            if (role === 'user') {
                div.className = "chat-user text-sm md:text-base leading-relaxed tracking-wide animate-pulse-once";
                div.innerHTML = `<div class="text-[10px] text-white/50 mb-1 tracking-widest">>> OPERATOR TX:</div>${formatted}`;
            } else {
                div.className = "chat-bot text-sm md:text-base leading-relaxed tracking-wide animate-pulse-once";
                div.innerHTML = `<div class="text-[10px] text-[#22c55e]/50 mb-1 tracking-widest text-red-500">>> RIKA (WITCH) RX:</div>${formatted}`;
            }
            UI.chat.appendChild(div);
            UI.chat.scrollTop = UI.chat.scrollHeight;
        }

        function resetChat() {
            UI.chat.innerHTML = '';
            historyList = [
                { role: "user", parts: [{ text: SYS_PROMPT }] },
                { role: "model", parts: [{ text: "Rika (Intelligence Mode) Online. The Council is seated.\nShow me the fragments, Operator. Let's see what they're trying to hide.\n\nMii~" }] }
            ];
            renderMsg('model', historyList[1].parts[0].text);
        }

        async function handleSend() {
            const text = UI.input.value.trim();
            if (!text) return;

            UI.input.value = '';
            renderMsg('user', text);
            historyList.push({ role: "user", parts: [{ text }] });

            const loadDiv = document.createElement('div');
            loadDiv.className = "text-[10px] text-red-500 animate-pulse tracking-widest mt-4";
            loadDiv.innerText = ">> DECRYPTING TARGET...";
            UI.chat.appendChild(loadDiv);
            UI.chat.scrollTop = UI.chat.scrollHeight;

            try {
                const res = await fetch("../../api/antigravity.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "gemini-3-pro-preview", contents: historyList }),
                });

                loadDiv.remove();
                const data = await res.json();
                const botText = data?.text || "[ NO RESPONSE ]";

                renderMsg('model', botText);
                historyList.push({ role: "model", parts: [{ text: botText }] });
            } catch (err) {
                loadDiv.remove();
                renderMsg('model', "[ SYSTEM ERROR :: API SEVERED. ]");
            }
        }

        UI.sendBtn.onclick = handleSend;
        UI.input.onkeypress = (e) => { if (e.key === 'Enter') handleSend(); };
        UI.clearBtn.onclick = resetChat;

        verify();
    </script>
</body>

</html>