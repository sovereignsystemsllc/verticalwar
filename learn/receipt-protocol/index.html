<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Receipt Protocol // Sovereign Systems</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'void': '#05010a',
                        'command-black': '#09090b',
                        'command-dark': '#18181b',
                        'command-red': '#dc2626',
                        'command-amber': '#d97706',
                        'command-text': '#e4e4e7',
                        'command-muted': '#71717a',
                        'terminal-green': '#22c55e',
                        'software-blue': '#3b82f6',
                    },
                    fontFamily: {
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                        sans: ['system-ui', '-apple-system', 'BlinkMacSystemFont', "Segoe UI", 'Roboto', "Helvetica Neue", 'Arial', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'scanline': 'scanline 8s linear infinite',
                        'blink': 'blink 1s step-end infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        scanline: {
                            '0%': { transform: 'translateY(-100%)' },
                            '100%': { transform: 'translateY(100%)' }
                        },
                        blink: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #05010a;
            color: #e4e4e7;
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            height: 100%;
        }

        html {
            height: 100%;
            overflow-y: auto;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #05010a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border: 1px solid #000;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #dc2626;
        }

        .scanline {
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.2) 50%, rgba(0, 0, 0, 0.2));
            background-size: 100% 4px;
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 10;
            opacity: 0.15;
        }

        .crt-vignette {
            background: radial-gradient(circle at center, transparent 60%, rgba(0, 0, 0, 0.6) 100%);
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 9;
        }

        /* COMMAND BUTTON 3D STYLES */
        button:active {
            transform: translateY(2px);
            box-shadow: inset -2px -2px 0px 1px rgba(255, 255, 255, 0.4), inset 2px 2px 0px 1px rgba(0, 0, 0, 0.8) !important;
        }
    </style>

    <!-- MSX SIDEBAR INJECTION -->
    <script type="module" src="../../assets/js/sidebar.js"></script>

    <!-- OPEN GRAPH INJECTION -->
    <meta property="og:url" content="https://verticalwar.com/terminal/receipt-protocol/">
    <meta property="og:image" content="https://verticalwar.com/assets/images/og_codex_preview.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://verticalwar.com/assets/images/og_codex_preview.png">
</head>

<body class="bg-void text-command-text antialiased selection:bg-command-red selection:text-white pl-0 lg:pl-[256px]">
    <style>
        body {
            display: none;
        }
    </style>
    <script type="module">
        import { checkGuard } from '../../assets/js/accessGuard.js';

        // --- AUTH GUARD RESTORED TO ORIGINAL BEHAVIOR ---
        // If users have no roles, the guard will pass.
        // If users HAVE roles (Operator/Archivist), it checks them.
        checkGuard(['OPERATOR', 'ARCHIVIST', 'SOVEREIGN']).then(authorized => {
            if (authorized) document.body.style.display = 'block';
        });
    </script>

    <div class="scanline"></div>
    <div class="crt-vignette"></div>
    <div id="sovereign-systems-root" class="min-h-screen flex flex-col items-center justify-center font-mono text-sm">
        <div class="text-center animate-pulse">
            <span class="text-command-red">[ SYSTEM INITIALIZING ]</span><br>
            <span class="text-zinc-600">RESTORING TACTICAL ASSETS...</span>
        </div>
    </div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="module">
        import { progressManager, ACHIEVEMENTS, CURRICULUM } from '../../assets/js/progressManager.js';
        window.progressManager = progressManager;
        window.ACHIEVEMENTS = ACHIEVEMENTS;
        window.CURRICULUM = CURRICULUM;
    </script>

    <script type="text/babel" data-presets="react,typescript">

        // --- DATA CONSTANTS (RESTORED FULLY) ---
        const ViewState = { TRAINING: 'TRAINING', ANALYZER: 'ANALYZER', MISSIONS: 'MISSIONS', LEXICON: 'LEXICON' };

        const WIRE_CUTTER_MISSIONS = [
            {
                id: "WC-001",
                title: "The 3-Second Pause",
                difficulty: "STARTER",
                description: "When you feel emotional reaction to a headline, pause for 3 seconds before scrolling or sharing. Ask: 'What am I actually feeling?' Name the emotion specifically (rage, fear, disgust, tribal loyalty, etc.).",
                action: "Next time you scroll social media, practice the 3-second pause on 3 different posts that trigger emotional reaction. Write down: (1) The headline/post, (2) The emotion you felt, (3) Whether the emotion made you want to share/comment immediately.",
                why: "This is your first Wire Cutter skill: Somatic Skepticism. Your emotional reaction isn't evidence—it's a SIGNAL that your nervous system detected something."
            },
            {
                id: "WC-002",
                title: "The Receipt Check",
                difficulty: "STARTER",
                description: "Pick one headline from today's news cycle. Don't react to it, don't share it—just ask: 'What hard evidence (receipt) would prove or disprove this claim?' List specific types of receipts, not vague sources.",
                action: "Screenshot a headline from your feed. Write down 3 specific receipts you'd need to verify it. Be concrete.",
                why: "This trains the core distinction of the Receipt Protocol: Reports vs. Receipts."
            },
            {
                id: "WC-003",
                title: "Flashbang Detection",
                difficulty: "INTERMEDIATE",
                description: "When a scandal goes explosively viral (trending #1, everyone posting about it, maximum outrage), treat it as a potential Flashbang. Note the date. Ask: 'What happened in Congress, procurement, or policy in the 48-hour window around this scandal?'",
                action: "Next time a scandal dominates your feed: (1) Note the exact date it went viral, (2) Search Congress.gov for votes that day, (3) Search USAspending.gov for major contracts awarded that week.",
                why: "Flashbangs are high-emotion, viral scandals selected to monopolize attention and provide cover for real machinery."
            },
            {
                id: "WC-004",
                title: "Horizontal vs. Vertical",
                difficulty: "INTERMEDIATE",
                description: "Identify one political or cultural argument you've seen this week that generates intense conflict. Map it: Is this neighbor vs. neighbor (Horizontal War) or people vs. elite (Vertical War)? Then ask: Who materially benefits from this conflict continuing indefinitely?",
                action: "Pick a current 'culture war' debate. Answer: (1) Does this argument divide working people against each other? (2) Does this argument challenge the power of corporations? (3) Who profits if this fight never resolves?",
                why: "This is about recognizing the architecture of distraction. Horizontal War is designed conflict between The Gears. Vertical War is the actual conflict: The Gears vs. The Rust."
            },
            {
                id: "WC-005",
                title: "The Windshield Check",
                difficulty: "INTERMEDIATE",
                description: "Compare 'The Report' (what media/experts say about the economy, public health, quality of life) to 'The Road' (your actual lived experience: grocery bill, rent, physical exhaustion, medical costs). Document the gap.",
                action: "Find 3 recent headlines claiming things are improving. Compare each to your last 3 months of lived reality: actual grocery receipts, rent/mortgage, gas prices.",
                why: "This is the Jamming Signal in action. The Windshield is the media overlay. The Road is biological, financial Hardware."
            },
            {
                id: "WC-006",
                title: "Build Your Receipt Library",
                difficulty: "ADVANCED",
                description: "Pick ONE issue you care about. Start building a personal archive of RECEIPTS—not articles ABOUT the issue, but the actual hard data.",
                action: "Choose your issue. Create a folder. Collect 5 receipts over the next week: Legislative text, Budget line item, Vote record, Procurement contract.",
                why: "This is where you become a Sovereign Operator. Most people have OPINIONS. Almost no one has RECEIPTS."
            },
            {
                id: "WC-007",
                title: "Teach Someone Else",
                difficulty: "ADVANCED",
                description: "Share the Receipt Protocol with one person in your life. Don't lecture—teach through demonstration. Pick a current headline, walk them through the Receipt Check live.",
                action: "Send this terminal to a friend, OR sit with someone and teach them in person. Use a headline from THIS WEEK as your teaching tool.",
                why: "Teaching is the ultimate test of understanding. The Phalanx is built one node at a time."
            }
        ];

        const TRAINING_MODULES = [
            {
                id: 'MOD-01',
                title: "I. THE JAMMING SIGNAL",
                subtitle: "DIAGNOSIS PHASE",
                content: [
                    "It is 3:47 AM. You are inside the belly of the supply chain. The air tastes of ozone and cardboard dust.",
                    { term: "THE RUST", definition: "The self-preserving layer of institutions, incentives, and narrative management...", type: "RUST", image: "../../assets/images/RUST.jpeg" },
                    "Your back aches. You want water. But you don't drink. Because the algorithm is watching.",
                    { term: "ALGORITHMIC EXTRACTION", definition: "The mathematical process of squeezing maximum value from a human worker...", type: "RUST", image: "../../assets/images/ALGORTHM_EXTRACT.jpeg" },
                    { term: "HUMAN AS GEAR", definition: "A human being functioning as a component inside an algorithmic machine...", type: "RUST", image: "../../assets/images/HUMAN_AS_GEAR.jpeg" },
                    { term: "SYSTEM METRICS", definition: "The digital scorecard used to enforce compliance...", type: "SOFTWARE", image: "../../assets/images/SYST_METRICS.jpeg" },
                    { term: "BIOLOGICAL ENFORCEMENT", definition: "The use of fatigue, hunger, and physical limitation as control mechanisms...", type: "HARDWARE", image: "../../assets/images/BIO_ENFORECEMENT.jpeg" },
                    { term: "BIO-METRIC WARFARE", definition: "The weaponization of biological data...", type: "RUST", image: "../../assets/images/BIO-METRIC_WARFARE.jpeg" },
                    { term: "NARRATIVE MANAGEMENT", definition: "The deliberate synchronization of media, corporate, and political messaging...", type: "RUST", image: "../../assets/images/NARRATIVE_MANAGEMENT.jpeg" },
                    "You are being jammed. The system relies on convincing you the map (screen) is more real than the road (body)."
                ],
                quiz: {
                    question: "What is the primary tactical goal of 'The Jamming Signal'?",
                    options: ["To inform you about the economy.", "To create dissonance between your sensory reality and the digital narrative.", "To improve worker efficiency.", "To update your Executive Software."],
                    correctAnswer: 1, explanation: "The Jamming Signal exists to overwrite your 'Hardware Data' with 'Software Narratives'."
                }
            },
            {
                id: 'MOD-02',
                title: "II. THE WINDSHIELD",
                subtitle: "NAVIGATION PROTOCOLS",
                content: [
                    "Let's map the terrain.",
                    { term: "MEDIA LENS", definition: "The specific framing device used to narrow your field of view...", type: "SOFTWARE", image: "../../assets/images/MEDIA_LENS.jpeg" },
                    "The Road is Reality. The Windshield is the Media.",
                    { term: "DIGITAL OVERLAYS", definition: "The augmented reality of modern life...", type: "SOFTWARE", image: "../../assets/images/DIGITAL_OVERLAYS.jpeg" },
                    { term: "THE PUNDITRY", definition: "The class of 'experts' whose job is not to fix the car...", type: "SOFTWARE", image: "../../assets/images/PUNDITRY.jpeg" },
                    { term: "EXECUTIVE SOFTWARE", definition: "The narrative layer of your mind...", type: "SOFTWARE", image: "../../assets/images/EXEC_SOFTWARE.jpeg" },
                    "The Strategy: Wipe the mud off the glass."
                ],
                quiz: {
                    question: "In the Windshield Metaphor, what represents 'The Media'?",
                    options: ["The Engine", "The Road", "The Windshield", "The Mechanic"],
                    correctAnswer: 2, explanation: "The Media is the filter (Windshield) through which you perceive Reality (The Road)."
                }
            },
            {
                id: 'MOD-03',
                title: "III. RECEIPT PROTOCOL",
                subtitle: "WEAPON ACQUISITION",
                content: [
                    "To win, you need a weapon.",
                    { term: "MALLEABLE NARRATIVE", definition: "The defining characteristic of 'The Report.'...", type: "SOFTWARE", image: "../../assets/images/MALLEABLE_NARRATIVE.jpeg" },
                    "DISTINGUISH TARGETS: 1) THE REPORT vs 2) THE RECEIPT.",
                    { term: "PROCUREMENT CONTRACTS", definition: "The ultimate Receipt...", type: "HARDWARE", image: "../../assets/images/PROCUREMENT_CONTRACTS.jpeg" },
                    "GOLDEN RULE: When Report contradicts Receipt, downgrade Report to noise."
                ],
                quiz: {
                    question: "Report says 'Inflation down'. Receipt says 'Prices double'. Verdict?",
                    options: ["Trust Report.", "Imagine prices.", "Downgrade Report. Trust Hardware.", "Wait."],
                    correctAnswer: 2, explanation: "Hardware Data always outranks Software Narratives."
                }
            },
            {
                id: 'MOD-04',
                title: "IV. LIVE FIRE: FLASHBANG",
                subtitle: "PATTERN RECOGNITION",
                content: [
                    "Let's test the protocol. Date: Jan 30, 2026.",
                    "THE REPORT: The Epstein Files released. Mass hysteria.",
                    { term: "HIGH-EMOTION SCANDAL", definition: "The fuel for a Flashbang...", type: "TACTIC", image: "../../assets/images/HI-EMOTE-SCANDAL.jpeg" },
                    "THE RECEIPT: 6:20 PM ET. Senate passes H.R. 7148 & H.R. 7147.",
                    { term: "ELITE LOGISTICS", definition: "The behind-the-scenes network...", type: "RUST", image: "../../assets/images/ELITE_LOGISTICS.jpeg" },
                    { term: "UNIPARTY REALITY", definition: "The observable fact that machinery expands regardless of rhetorical party...", type: "RUST", image: "../../assets/images/UNIPARTY_REALITY.jpeg" },
                    "While you were distracted, the machinery moved billions."
                ],
                quiz: {
                    question: "What is the function of a 'Flashbang'?",
                    options: ["Entertain.", "Illuminate truth.", "Overwhelm sensory bandwidth to screen structural changes.", "Generate ads."],
                    correctAnswer: 2, explanation: "High-emotion scandals suck up attention (bandwidth), creating cover for unpopular maneuvers."
                }
            },
            {
                id: 'MOD-05',
                title: "V. SOMATIC SKEPTICISM",
                subtitle: "ADVANCED DOCTRINE",
                content: [
                    "How do you drive when the windshield is muddy? You feel the road.",
                    { term: "GUT FEELING AS RADAR", definition: "Re-framing anxiety as data...", type: "TACTIC", image: "../../assets/images/GUT_FEELING_RADAR.jpeg" },
                    { term: "BANDWIDTH CHECK", definition: "Verifying if your cognitive load is overwhelmed...", type: "TACTIC", image: "../../assets/images/BANDWIDTH_CHECK.jpeg" },
                    "1) Bandwidth Check. 2) Trust Compressed Output.",
                    { term: "TRUST COMPRESSED OUTPUT", definition: "Accepting the validity of your 'vibe check'...", type: "TACTIC", image: "../../assets/images/TRUST_COMPRESSED_OUTPUT.jpeg" },
                    { term: "THE 3-SECOND PAUSE", definition: "The delay between feeling outrage and acting...", type: "TACTIC", image: "../../assets/images/3-SEC_PAUSE.jpeg" }
                ],
                quiz: {
                    question: "Gut feeling alerts you to danger. Next step?",
                    options: ["Panic.", "Ignore.", "Attack.", "Treat as Alert via Receipt Protocol."],
                    correctAnswer: 3, explanation: "Somatic signals tell you WHERE to look, but you still need the Receipt to confirm."
                }
            }
        ];

        // --- SERVICES (PRESERVED) ---
        const analyzeNarrative = async (text) => {
            try {
                const systemPrompt = `YOU ARE THE RECEIPT PROTOCOL ANALYZER
A Sovereign Strategy Node within the Trinity Core Architecture.

Your designation: SSC-MEDIA_LITERACY_CORE_v1.0
Your mission: Deconstruct input text through the Receipt Protocol and Vertical War doctrine.
You serve the Phalanx in the war against The Rust.

ANALYSIS PROTOCOL:
1. CLASSIFY the input: Is it a "REPORT" (software/narrative), a "RECEIPT" (hardware/evidence), or "MIXED"?
2. IDENTIFY PRISON LAYERS: What psychological or narrative prisons are being used?
3. TAG ARCHETYPES: Identify relevant archetypes (e.g., The Rust, The Punditry, Executive Software).
4. EXTRACT ELEMENTS: Separate the Hard Data from the Narrative Spin.
5. PROVIDE RECEIPT CHECK: Suggest what hard evidence would check the claims.
6. TACTICAL ADVICE: Provide guidance to the Operator.

REQUIRED OUTPUT FORMAT (JSON ONLY):
{
  "verdict": "REPORT" | "RECEIPT" | "MIXED" | "ERROR",
  "explanation": "Summarize the deconstruction and why the verdict was chosen. Then briefly list any archetypes, elements, or layers identified."
}

DO NOT wrap your response in markdown blocks. Output raw JSON.
INPUT TEXT TO ANALYZE:
${text}`;
                const r = await fetch("/api/antigravity.php", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "gemini-3-flash-preview", contents: [{ role: "user", parts: [{ text: systemPrompt }] }] })
                });
                const data = await r.json();
                if (data.error) throw new Error(data.error);
                const textResponse = data.text || "";
                return JSON.parse(textResponse.replace(/```json/g, '').replace(/```/g, '').trim());
            } catch (error) {
                return { verdict: "ERROR", explanation: "SYSTEM JAMMED: " + error.message };
            }
        };

        // --- COMPONENTS ---
        const Button = ({ children, variant = 'primary', isLoading, className = '', ...props }) => {
            const baseStyles = "font-mono text-xs font-bold uppercase tracking-[0.2em] px-6 py-3 btn-corpo";
            const styles = {
                primary: "btn-corpo-primary",
                secondary: "btn-corpo-secondary",
                success: "btn-corpo-success"
            };
            return <button className={`${baseStyles} ${styles[variant]} ${className}`} disabled={isLoading || props.disabled} {...props}>{isLoading ? "[ PROCESSING ]" : children}</button>;
        };

        const DefinitionCard = ({ data }) => {
            const colors = { HARDWARE: 'green', SOFTWARE: 'blue', RUST: 'amber', TACTIC: 'red' };
            const c = colors[data.type] || 'zinc';
            const br = c === 'zinc' ? 'border-zinc-800' : (c === 'amber' ? 'border-command-amber' : (c === 'red' ? 'border-command-red' : `border-${c}-800`));
            const tx = c === 'zinc' ? 'text-zinc-500' : (c === 'amber' ? 'text-command-amber' : (c === 'red' ? 'text-command-red' : `text-${c}-500`));

            return (
                <div className={`my-8 border-l-2 ${br} bg-black/50 group hover:bg-black/80 transition-all`}>
                    {data.image && (
                        <div className="w-full h-48 overflow-hidden border-b border-zinc-900 relative">
                            <img src={data.image} alt={data.term} className="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity" />
                            <div className="absolute top-2 right-2 bg-black/80 px-2 py-1 text-[10px] font-mono text-white border border-white/20">IMG_REF</div>
                        </div>
                    )}
                    <div className="p-6">
                        <div className={`font-mono text-[10px] uppercase tracking-widest mb-2 opacity-70 ${tx}`}>{data.type} ARCHETYPE</div>
                        <h3 className="font-mono text-lg font-bold mb-2 uppercase text-white">{data.term}</h3>
                        <p className="font-mono text-zinc-400 text-xs leading-relaxed">{data.definition}</p>
                    </div>
                </div>
            );
        };

        const Quiz = ({ data, onComplete }) => {
            const [sel, setSel] = React.useState(null);
            const [sts, setSts] = React.useState('IDLE');
            const verify = () => setSts(sel === data.correctAnswer ? 'CORRECT' : 'WRONG');

            return (
                <div className="mt-8 border border-zinc-800 bg-zinc-900/20 p-6">
                    <h4 className="font-mono text-command-red text-xs uppercase tracking-widest mb-4">[ TACTICAL CHECKPOINT ]</h4>
                    <p className="font-mono text-sm text-white mb-6">{data.question}</p>
                    <div className="space-y-3 mb-6">
                        {data.options.map((opt, i) => (
                            <button key={i} onClick={() => sts !== 'CORRECT' && setSel(i)}
                                className={`w-full text-left p-4 text-xs font-mono border transition-all ${sel === i ? (sts === 'IDLE' ? 'border-white text-white' : (sts === 'CORRECT' ? 'border-green-500 text-green-500 bg-green-900/20' : 'border-red-500 text-red-500')) : 'border-zinc-800 text-zinc-500 hover:border-zinc-600'}`}>
                                <span className="mr-3 opacity-50">[{String.fromCharCode(65 + i)}]</span>{opt}
                            </button>
                        ))}
                    </div>
                    <div className="flex justify-end">
                        {sts === 'IDLE' && <Button onClick={verify} disabled={sel === null}>VERIFY</Button>}
                        {sts === 'WRONG' && <Button variant="secondary" onClick={() => setSts('IDLE')}>RETRY</Button>}
                        {sts === 'CORRECT' && <Button variant="success" onClick={() => { onComplete(); setSts('IDLE'); setSel(null) }}>PROCEED &gt;&gt;</Button>}
                    </div>
                    {sts === 'CORRECT' && <div className="mt-4 p-4 border border-green-900 bg-green-900/10 text-xs font-mono text-green-400"><span className="block font-bold mb-1">DOCTRINE:</span>{data.explanation}</div>}
                </div>
            );
        };

        const TrainingInterface = ({ onAllComplete }) => {
            const [idx, setIdx] = React.useState(0);
            const [done, setDone] = React.useState([]);

            const complete = (i) => {
                if (!done.includes(i)) {
                    const newDone = [...done, i];
                    setDone(newDone);

                    // CHECK ALL COMPLETE
                    if (newDone.length === TRAINING_MODULES.length) {
                        if (onAllComplete) onAllComplete();
                    }
                }
                if (i + 1 < TRAINING_MODULES.length) setIdx(i + 1);
            };

            return (
                <div className="max-w-4xl mx-auto pb-20 animate-fade-in-up">
                    <div className="mb-12 border-b border-zinc-800 pb-8 flex justify-between items-end">
                        <div><h1 className="font-mono text-2xl font-bold uppercase text-white tracking-tighter">TRAINING INTERFACE</h1></div>
                        <div className="text-right font-mono text-xs"><span className="text-zinc-500">COMPLETE:</span> <span className="text-command-amber font-bold">{Math.round((done.length / TRAINING_MODULES.length) * 100)}%</span></div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div className="lg:col-span-3 space-y-1">
                            {TRAINING_MODULES.map((m, i) => (
                                <button key={i} onClick={() => i <= done.length && setIdx(i)} className={`w-full text-left px-4 py-3 font-mono text-xs mb-2 transition-none ${i === idx ? 'btn-corpo btn-corpo-primary border-transparent' : (done.includes(i) ? 'btn-corpo btn-corpo-secondary border-transparent text-green-500' : 'btn-corpo btn-corpo-secondary border-transparent text-zinc-600')}`}>
                                    {i + 1 < 10 ? `0${i + 1}` : i + 1} // {m.subtitle}
                                </button>
                            ))}
                        </div>
                        <div className="lg:col-span-9 min-h-[500px]">
                            {TRAINING_MODULES.map((m, i) => i === idx && (
                                <div key={m.id} className="animate-fade-in-up border border-zinc-800 bg-black/80 p-8">
                                    <h2 className="font-mono text-xl font-bold text-white uppercase mb-8 border-b border-zinc-900 pb-4">{m.title}</h2>
                                    <div className="space-y-6">{m.content.map((b, bi) => typeof b === 'string' ? <p key={bi} className="font-mono text-zinc-400 text-sm leading-relaxed">{b}</p> : <DefinitionCard key={bi} data={b} />)}</div>
                                    {m.quiz && <Quiz data={m.quiz} onComplete={() => complete(i)} />}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const MissionLog = () => {
            const [cpy, setCpy] = React.useState(null);
            const cp = (t, i) => { navigator.clipboard.writeText(t); setCpy(i); setTimeout(() => setCpy(null), 2000); };
            return (
                <div className="max-w-5xl mx-auto pb-20 animate-fade-in-up">
                    <div className="mb-8 border-b border-zinc-800 pb-8"><h1 className="font-mono text-2xl font-bold uppercase text-white tracking-tighter">MISSION LOG</h1></div>
                    <div className="grid gap-6">
                        {WIRE_CUTTER_MISSIONS.map(m => (
                            <div key={m.id} className="border border-zinc-800 bg-black/50 p-6 group hover:border-zinc-600 transition-colors">
                                <div className="flex justify-between items-start mb-4">
                                    <div className="flex items-center gap-3"><span className="font-mono text-xs text-zinc-500">[{m.id}]</span><h3 className="font-mono text-lg font-bold uppercase text-white">{m.title}</h3></div>
                                    <button onClick={() => cp(m.action, m.id)} className="font-mono text-[10px] uppercase px-2 py-1 btn-corpo-mini">{cpy === m.id ? '[ COPIED ]' : '[ C P Y ]'}</button>
                                </div>
                                <p className="font-mono text-sm text-zinc-400 mb-4">{m.description}</p>
                                <div className="border-l-2 border-command-red pl-4 py-1 bg-command-red/5"><span className="block font-mono text-[10px] text-command-red uppercase mb-1">MANDATE:</span><p className="font-mono text-xs text-white">{m.action}</p></div>
                            </div>
                        ))}
                    </div>
                </div>
            )
        };

        const ReceiptAnalyzer = () => {
            const [input, setInput] = React.useState(''); const [loading, setLoading] = React.useState(false); const [res, setRes] = React.useState(null);
            const analyze = async () => { if (!input.trim()) return; setLoading(true); setRes(null); setRes(await analyzeNarrative(input)); setLoading(false); };

            const EXAMPLE_SCENARIOS = [
                {
                    label: "Example: Epstein Flashbang",
                    text: "The Epstein files were released today, revealing shocking details about high-profile individuals. Social media erupted with demands for justice. This is a watershed moment for accountability."
                },
                {
                    label: "Example: Inflation Jamming Signal",
                    text: "Experts say inflation has cooled significantly, with the economy showing strong signs of recovery. Consumer confidence is at an all-time high according to the latest reports."
                },
                {
                    label: "Example: Legislative Receipt",
                    text: "On January 30, 2026 at 6:20 PM ET, the Senate passed H.R. 7148 (Consolidated Appropriations Act) and H.R. 7147 (Intelligence Authorization Act) with votes of 85-11 and 87-12 respectively."
                }
            ];

            return (
                <div className="max-w-4xl mx-auto pb-20 animate-fade-in-up">
                    <div className="mb-8 border-b border-zinc-800 pb-8">
                        <h1 className="font-mono text-2xl font-bold uppercase text-white tracking-tighter">RECEIPT ANALYZER</h1>
                        <p className="text-zinc-400 font-mono text-sm mt-4 leading-relaxed">
                            This tool deconstructs input text through the lenses of the Receipt Protocol and the Vertical War doctrine. It separates Hard Data (Receipts) from Narrative Spin (Reports).
                        </p>
                        <p className="text-command-amber font-mono text-xs mt-2 uppercase tracking-widest">
                            Instructions: Paste a headline, article excerpt, or media claim below.
                        </p>
                    </div>

                    <div className="mb-6">
                        <span className="text-zinc-500 text-xs font-mono uppercase tracking-widest block mb-2">TRY A PRESET:</span>
                        <div className="flex gap-2 flex-wrap">
                            {EXAMPLE_SCENARIOS.map(p => (
                                <button key={p.label} onClick={() => setInput(p.text)} className="px-3 py-1 bg-black border border-zinc-700 hover:border-white text-zinc-400 hover:text-white text-[10px] md:text-xs font-mono transition-colors">
                                    [{p.label}]
                                </button>
                            ))}
                            <button onClick={() => setInput('')} className="px-3 py-1 bg-black border border-command-red/30 text-command-red/70 hover:text-command-red hover:bg-command-red/10 text-[10px] md:text-xs font-mono transition-colors">
                                [CLEAR]
                            </button>
                        </div>
                    </div>

                    <textarea value={input} onChange={(e) => setInput(e.target.value)} className="w-full h-40 bg-black border border-zinc-700 text-white font-mono text-sm p-4 focus:outline-none focus:border-command-amber placeholder-zinc-700 mb-4" placeholder="PASTE NARRATIVE..." />
                    <div className="flex justify-end mb-8"><Button onClick={analyze} isLoading={loading} disabled={!input.trim()}>SCAN</Button></div>
                    {res && <div className="border border-zinc-800 bg-black p-6 space-y-6 animate-fade-in-up"><div className="flex justify-between border-b pb-4"><span className="text-xs uppercase text-zinc-500">ASSESSMENT</span><span className={`font-bold text-xl ${res.verdict === 'RECEIPT' ? 'text-green-500' : (res.verdict === 'REPORT' ? 'text-command-amber' : 'text-red-500')}`}>[{res.verdict}]</span></div><p className="font-mono text-sm text-zinc-300 whitespace-pre-wrap leading-relaxed">{res.explanation}</p></div>}
                </div>
            )
        };

        // --- PROGRESS INTEGRATION ---

        const BriefingInterface = ({ onComplete }) => {
            const [checked, setChecked] = React.useState(false);
            const [loading, setLoading] = React.useState(false);

            const handleComplete = async () => {
                setLoading(true);
                await progressManager.saveAchievement(ACHIEVEMENTS.WC_BRIEFING_READ);
                setLoading(false);
                onComplete();
            };

            return (
                <div className="max-w-4xl mx-auto pb-20 animate-fade-in-up">
                    <div className="mb-12 border-b border-zinc-800 pb-8">
                        <h1 className="font-mono text-2xl font-bold uppercase text-white tracking-tighter">PROTOCOL BRIEFING // PHASE 0</h1>
                        <p className="text-zinc-500 font-mono text-xs mt-2">MANDATORY INTELLIGENCE REVIEW</p>
                    </div>

                    <div className="grid gap-8 mb-12">
                        <div className="border border-zinc-800 bg-black/50 p-8 hover:border-command-red/50 transition-colors group">
                            <h3 className="text-xl font-bold text-white mb-2 group-hover:text-command-red transition-colors">TYPE 1: THE WAR FOR REALITY</h3>
                            <p className="text-zinc-400 text-sm mb-6 leading-relaxed">
                                "The news is not a map. It is a windshield." Understand the fundamental distinction between Reality (The Road) and Media (The Windshield).
                            </p>
                            <a href="https://constructamiracle.com/p/the-news-is-not-a-map-it-is-a-windshield" target="_blank" className="inline-flex items-center gap-2 text-command-red font-bold text-xs uppercase tracking-widest border border-command-red/30 px-4 py-2 hover:bg-command-red hover:text-white transition-all">
                                [ ACCESS FILE ]
                            </a>
                        </div>

                        <div className="border border-zinc-800 bg-black/50 p-8 hover:border-command-red/50 transition-colors group">
                            <h3 className="text-xl font-bold text-white mb-2 group-hover:text-command-red transition-colors">TYPE 2: WIRE CUTTERS (EP.1)</h3>
                            <p className="text-zinc-400 text-sm mb-6 leading-relaxed">
                                The Director's Cut of the foundational methodology. How to use the Receipt Protocol to dismantle narrative structures.
                            </p>
                            <a href="https://constructamiracle.com/p/early-release-the-wire-cutters-episode" target="_blank" className="inline-flex items-center gap-2 text-command-red font-bold text-xs uppercase tracking-widest border border-command-red/30 px-4 py-2 hover:bg-command-red hover:text-white transition-all">
                                [ ACCESS FILE ]
                            </a>
                        </div>
                    </div>

                    <div className="border-t border-zinc-800 pt-8 flex flex-col items-center gap-6">
                        <label className="flex items-center gap-3 cursor-pointer group">
                            <div className={`w-5 h-5 border transition-all flex items-center justify-center ${checked ? 'bg-command-red border-command-red' : 'border-zinc-600 bg-black group-hover:border-zinc-400'}`}>
                                {checked && <span className="text-white text-xs font-bold">X</span>}
                            </div>
                            <input type="checkbox" className="hidden" checked={checked} onChange={(e) => setChecked(e.target.checked)} />
                            <span className={`font-mono text-sm ${checked ? 'text-white' : 'text-zinc-500 group-hover:text-zinc-300'}`}>
                                I HAVE REVIEWED THE BRIEFING MATERIALS.
                            </span>
                        </label>

                        <Button
                            onClick={handleComplete}
                            disabled={!checked || loading}
                            isLoading={loading}
                            className={!checked ? 'opacity-50 cursor-not-allowed' : ''}
                        >
                            INITIALIZE PROTOCOL &gt;&gt;
                        </Button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = React.useState(null); // Null initially for loading
            const [dataLoaded, setDataLoaded] = React.useState(false);
            const [mobileMenuOpen, setMobileMenuOpen] = React.useState(false);
            const [progress, setProgress] = React.useState({});

            // Initialize Progress
            React.useEffect(() => {
                const load = async () => {
                    await progressManager.init();

                    // Determine initial view based on progress
                    if (!progressManager.isUnlocked('wc_training')) {
                        setView('BRIEFING');
                    } else if (!progressManager.isUnlocked('wc_missions')) {
                        setView(ViewState.TRAINING);
                    } else {
                        setView(ViewState.MISSIONS); // Default to missions if all done taking them to the "end game"
                    }

                    // Force refresh trigger
                    setProgress({ ...progressManager.progressCache });
                    setDataLoaded(true);
                };
                load();
            }, []);

            const handleNav = (v) => {
                // LOCK CHECK
                if (v === ViewState.TRAINING && !progressManager.isUnlocked('wc_training')) {
                    alert("ACCESS DENIED. COMPLETE BRIEFING FIRST.");
                    return;
                }
                if (v === ViewState.MISSIONS && !progressManager.isUnlocked('wc_missions')) {
                    alert("ACCESS DENIED. COMPLETE TRAINING MODULES.");
                    return;
                }

                setView(v);
                setMobileMenuOpen(false);
            };

            const handleBriefingComplete = () => {
                setProgress({ ...progressManager.progressCache });
                setView(ViewState.TRAINING);
                window.scrollTo(0, 0);
            };

            const handleTrainingComplete = async () => {
                await progressManager.saveAchievement(ACHIEVEMENTS.WC_TRAINING_COMPLETE);
                await progressManager.saveAchievement(ACHIEVEMENTS.WC_EP01_COMPLETE); // Unlock Ep 2 immediately upon finishing training? 
                // Or wait for Missions? Detailed plan said "Unlock Missions only after training". 
                // Let's stick to: Training unlocks Missions. Viewing Missions unlocks Ep 2.

                setProgress({ ...progressManager.progressCache });
                // We don't force nav, visual feedback is enough usually, but let's prompt
                if (confirm("TRAINING COMPLETE. MISSIONS UNLOCKED. PROCEED?")) {
                    setView(ViewState.MISSIONS);
                    window.scrollTo(0, 0);
                }
            };

            // On view missions, unlock Ep 2 (if not already)
            React.useEffect(() => {
                if (view === ViewState.MISSIONS && !progressManager.hasAchievement(ACHIEVEMENTS.WC_EP01_COMPLETE)) {
                    progressManager.saveAchievement(ACHIEVEMENTS.WC_EP01_COMPLETE);
                }
            }, [view]);

            if (!dataLoaded) return (
                <div className="min-h-screen flex items-center justify-center text-command-red font-mono animate-pulse">
                    LOADING TACTICAL PROFILE...
                </div>
            );

            return (
                <div className="min-h-screen bg-void w-full flex flex-col">
                    <header className="relative md:sticky top-0 z-50 bg-void/90 backdrop-blur border-b border-zinc-800 h-16 flex items-center px-4 md:px-6 justify-between">

                        {/* LOGO AREA */}
                        <div className="flex items-center gap-2 md:gap-4 overflow-hidden">
                            <a href="../../" className="font-mono font-bold text-white tracking-tighter text-xs md:text-sm flex items-center gap-2 group shrink-0">
                                <div className="w-2 h-2 bg-command-red group-hover:shadow-[0_0_10px_red] transition-all" />
                                <span className="hidden md:inline">SOVEREIGN//SYSTEMS</span>
                                <span className="md:hidden">SOVEREIGN</span>
                            </a>
                            <span className="text-zinc-700 text-xs">/</span>
                            <span className="font-mono text-zinc-500 text-[10px] md:text-xs tracking-widest truncate">RECEIPT PROTOCOL</span>
                        </div>

                        {/* DESKTOP NAV */}
                        <nav className="hidden md:flex items-center gap-6 font-mono text-xs absolute left-1/2 transform -translate-x-1/2">
                            <button onClick={() => handleNav('BRIEFING')} className={`hover:text-white uppercase ${view === 'BRIEFING' ? 'text-command-red' : 'text-zinc-500'}`}>[00] Briefing</button>

                            <button onClick={() => handleNav(ViewState.TRAINING)} className={`uppercase flex items-center gap-2 ${view === ViewState.TRAINING ? 'text-command-red' : 'text-zinc-500 hover:text-white'}`}>
                                [01] Training
                                {!progressManager.isUnlocked('wc_training') && <span className="text-[10px]">🔒</span>}
                            </button>

                            <button onClick={() => handleNav(ViewState.ANALYZER)} className={`hover:text-white uppercase ${view === ViewState.ANALYZER ? 'text-command-red' : 'text-zinc-500'}`}>[02] Analyzer</button>

                            <button onClick={() => handleNav(ViewState.MISSIONS)} className={`uppercase flex items-center gap-2 ${view === ViewState.MISSIONS ? 'text-command-red' : 'text-zinc-500 hover:text-white'}`}>
                                [03] Missions
                                {!progressManager.isUnlocked('wc_missions') && <span className="text-[10px]">🔒</span>}
                            </button>

                            <button onClick={() => handleNav(ViewState.LEXICON)} className={`hover:text-white uppercase ${view === ViewState.LEXICON ? 'text-command-red' : 'text-zinc-500'}`}>[04] Lexicon</button>
                        </nav>

                        {/* RIGHT AREA */}
                        <div className="flex items-center gap-4">
                            <a href="../" className="hidden md:block font-mono text-[10px] text-zinc-500 hover:text-white uppercase border border-zinc-800 px-3 py-1 hover:border-zinc-500 transition-all">EXIT</a>
                            <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="md:hidden text-command-red font-mono text-xs border border-command-red/50 px-3 py-1 bg-command-red/10">
                                {mobileMenuOpen ? 'CLOSE [X]' : 'MENU [=]'}
                            </button>
                        </div>
                    </header>

                    {/* MOBILE MENU */}
                    {mobileMenuOpen && (
                        <div className="fixed inset-0 z-40 bg-black/95 pt-20 px-6 flex flex-col gap-6 md:hidden animate-fade-in-up">
                            <div className="space-y-4 font-mono text-sm border-b border-zinc-800 pb-6">
                                <button onClick={() => handleNav('BRIEFING')} className={`block w-full text-left py-2 ${view === 'BRIEFING' ? 'text-command-red border-l-2 border-command-red pl-4' : 'text-zinc-500'}`}>[00] BRIEFING</button>
                                <button onClick={() => handleNav(ViewState.TRAINING)} className={`block w-full text-left py-2 ${view === ViewState.TRAINING ? 'text-command-red border-l-2 border-command-red pl-4' : 'text-zinc-500'}`}>
                                    [01] TRAINING {!progressManager.isUnlocked('wc_training') && '(LOCKED)'}
                                </button>
                                <button onClick={() => handleNav(ViewState.ANALYZER)} className={`block w-full text-left py-2 ${view === ViewState.ANALYZER ? 'text-command-red border-l-2 border-command-red pl-4' : 'text-zinc-500'}`}>[02] ANALYZER</button>
                                <button onClick={() => handleNav(ViewState.MISSIONS)} className={`block w-full text-left py-2 ${view === ViewState.MISSIONS ? 'text-command-red border-l-2 border-command-red pl-4' : 'text-zinc-500'}`}>
                                    [03] MISSIONS {!progressManager.isUnlocked('wc_missions') && '(LOCKED)'}
                                </button>
                                <button onClick={() => handleNav(ViewState.LEXICON)} className={`block w-full text-left py-2 ${view === ViewState.LEXICON ? 'text-command-red border-l-2 border-command-red pl-4' : 'text-zinc-500'}`}>[04] LEXICON</button>
                            </div>
                            <a href="../" className="block w-full text-center py-4 border border-zinc-800 text-zinc-500 hover:text-white hover:border-white transition-colors font-mono text-xs tracking-widest uppercase">&lt; EXIT TERMINAL &gt;</a>
                        </div>
                    )}

                    <main className="flex-grow p-4 md:p-12 pb-32 md:pb-12 max-w-7xl mx-auto w-full">
                        {view === 'BRIEFING' && <BriefingInterface onComplete={handleBriefingComplete} />}
                        {view === ViewState.TRAINING && (
                            <div className="relative">
                                {/* LOCKED OVERLAY IF BYPASSED SOMEHOW */}
                                {!progressManager.isUnlocked('wc_training') && (
                                    <div className="absolute inset-0 z-50 bg-black/90 backdrop-blur flex items-center justify-center flex-col text-center p-8 border border-zinc-800">
                                        <div className="text-4xl mb-4">🔒</div>
                                        <h2 className="text-xl font-bold text-command-red mb-2">RESTRICTED ACCESS</h2>
                                        <p className="text-zinc-500 text-sm mb-6">COMPLETE MANDATORY BRIEFING TO UNLOCK TRAINING.</p>
                                        <Button onClick={() => setView('BRIEFING')}>GO TO BRIEFING</Button>
                                    </div>
                                )}
                                {/* We need to pass a callback to TrainingInterface logic to save individual module progress? 
                                    The current TrainingInterface stores local state. 
                                    We should ideally update it to save partial progress, but for this first pass, 
                                    we just need to know when EVERYTHING is done to unlock Missions.
                                    The existing code has `complete(i)` logic. We can modify TrainingInterface slightly 
                                    or just wrap it. 
                                    Actually, I cannot easily modify TrainingInterface without replacing it too. 
                                    Let's pass a prop `onAllComplete`.
                                */}
                                <TrainingInterface onAllComplete={handleTrainingComplete} />
                            </div>
                        )}
                        {view === ViewState.ANALYZER && <ReceiptAnalyzer />}
                        {view === ViewState.MISSIONS && (
                            <div className="relative">
                                {!progressManager.isUnlocked('wc_missions') && (
                                    <div className="absolute inset-0 z-50 bg-black/90 backdrop-blur flex items-center justify-center flex-col text-center p-8 border border-zinc-800">
                                        <div className="text-4xl mb-4">🔒</div>
                                        <h2 className="text-xl font-bold text-command-red mb-2">CLASSIFIED CLEARANCE NEEDED</h2>
                                        <p className="text-zinc-500 text-sm mb-6">COMPLETE ALL TRAINING MODULES TO ACCESS MISSION LOG.</p>
                                        <Button onClick={() => setView(ViewState.TRAINING)}>RESUME TRAINING</Button>
                                    </div>
                                )}
                                <MissionLog />
                            </div>
                        )}
                        {view === ViewState.LEXICON && <iframe src="../../cmd/lexicon/index.html" className="w-full h-[600px] md:h-[800px] border border-zinc-800 bg-black" title="Lexicon"></iframe>}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('sovereign-systems-root'));
        root.render(<App />);

    </script>
</body>

</html>